<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Promise &amp; ç”Ÿæˆå™¨ &amp; await async |  Best Programming Language ï¼Ÿ ğŸ˜ˆ JAVASCRIPT</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Just learn and run">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.d0f45259.js" as="script"><link rel="preload" href="/assets/js/2.9e697bc4.js" as="script"><link rel="preload" href="/assets/js/32.78085356.js" as="script"><link rel="prefetch" href="/assets/js/10.48b8c953.js"><link rel="prefetch" href="/assets/js/11.f612be11.js"><link rel="prefetch" href="/assets/js/12.b835a644.js"><link rel="prefetch" href="/assets/js/13.be4ff992.js"><link rel="prefetch" href="/assets/js/14.bbd05573.js"><link rel="prefetch" href="/assets/js/15.1b4ee2f2.js"><link rel="prefetch" href="/assets/js/16.588a1728.js"><link rel="prefetch" href="/assets/js/17.ae68adab.js"><link rel="prefetch" href="/assets/js/18.68e9d6df.js"><link rel="prefetch" href="/assets/js/19.d2991acb.js"><link rel="prefetch" href="/assets/js/20.8fe6b2cd.js"><link rel="prefetch" href="/assets/js/21.12c5dbb4.js"><link rel="prefetch" href="/assets/js/22.ddd0487c.js"><link rel="prefetch" href="/assets/js/23.4cead595.js"><link rel="prefetch" href="/assets/js/24.0a65f294.js"><link rel="prefetch" href="/assets/js/25.0c8ed6b4.js"><link rel="prefetch" href="/assets/js/26.6591a69e.js"><link rel="prefetch" href="/assets/js/27.ff0fa1ef.js"><link rel="prefetch" href="/assets/js/28.858f8826.js"><link rel="prefetch" href="/assets/js/29.3f6b44e9.js"><link rel="prefetch" href="/assets/js/3.0b8b26d0.js"><link rel="prefetch" href="/assets/js/30.69cef0d1.js"><link rel="prefetch" href="/assets/js/31.576782ee.js"><link rel="prefetch" href="/assets/js/33.25cb7d39.js"><link rel="prefetch" href="/assets/js/34.d18511e2.js"><link rel="prefetch" href="/assets/js/35.6dc2bd90.js"><link rel="prefetch" href="/assets/js/36.b695c924.js"><link rel="prefetch" href="/assets/js/37.d803bac1.js"><link rel="prefetch" href="/assets/js/38.8abd0adb.js"><link rel="prefetch" href="/assets/js/39.3b23f090.js"><link rel="prefetch" href="/assets/js/4.e7c996f5.js"><link rel="prefetch" href="/assets/js/40.31a5553f.js"><link rel="prefetch" href="/assets/js/41.96f2dfc6.js"><link rel="prefetch" href="/assets/js/42.da2b78c0.js"><link rel="prefetch" href="/assets/js/43.2b80b114.js"><link rel="prefetch" href="/assets/js/44.03f54269.js"><link rel="prefetch" href="/assets/js/45.182bfe6b.js"><link rel="prefetch" href="/assets/js/46.cede0b20.js"><link rel="prefetch" href="/assets/js/47.869f0654.js"><link rel="prefetch" href="/assets/js/48.b8a8b538.js"><link rel="prefetch" href="/assets/js/49.d919b506.js"><link rel="prefetch" href="/assets/js/5.6eff8140.js"><link rel="prefetch" href="/assets/js/50.b754644d.js"><link rel="prefetch" href="/assets/js/51.a3cf1047.js"><link rel="prefetch" href="/assets/js/52.4ee6e441.js"><link rel="prefetch" href="/assets/js/6.17d5dd20.js"><link rel="prefetch" href="/assets/js/7.576da1bf.js"><link rel="prefetch" href="/assets/js/8.6fffe5ac.js"><link rel="prefetch" href="/assets/js/9.0041b96e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name"> Best Programming Language ï¼Ÿ ğŸ˜ˆ JAVASCRIPT</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>frontend</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>javascript</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/frontend/javascript/promise_await_async/" aria-current="page" class="active sidebar-link">promiseçš„å‰ä¸–ä»Šç”Ÿ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/frontend/javascript/promise_await_async/#å¼‚æ­¥ç¼–ç¨‹æ ¸å¿ƒ-ç¨‹åºä¸­ç°åœ¨è¿è¡Œçš„éƒ¨åˆ†å’Œå°†æ¥è¿è¡Œçš„éƒ¨åˆ†ä¹‹é—´çš„å…³ç³»ã€‚" class="sidebar-link">å¼‚æ­¥ç¼–ç¨‹æ ¸å¿ƒï¼šç¨‹åºä¸­ç°åœ¨è¿è¡Œçš„éƒ¨åˆ†å’Œå°†æ¥è¿è¡Œçš„éƒ¨åˆ†ä¹‹é—´çš„å…³ç³»ã€‚</a></li><li class="sidebar-sub-header"><a href="/frontend/javascript/promise_await_async/#å¼‚æ­¥æ“ä½œ-ä¾‹å­-log" class="sidebar-link">å¼‚æ­¥æ“ä½œï¼Œä¾‹å­ï¼šlog</a></li><li class="sidebar-sub-header"><a href="/frontend/javascript/promise_await_async/#æµè§ˆå™¨çš„eventloop" class="sidebar-link">æµè§ˆå™¨çš„eventloop</a></li><li class="sidebar-sub-header"><a href="/frontend/javascript/promise_await_async/#å›è°ƒåœ°ç‹±" class="sidebar-link">å›è°ƒåœ°ç‹±</a></li><li class="sidebar-sub-header"><a href="/frontend/javascript/promise_await_async/#zalgo-in-hell-åœ°ç‹±ä¸­çš„æ¶é­”-ä¿¡ä»»é—®é¢˜" class="sidebar-link">Zalgo in hell åœ°ç‹±ä¸­çš„æ¶é­” - ä¿¡ä»»é—®é¢˜</a></li><li class="sidebar-sub-header"><a href="/frontend/javascript/promise_await_async/#promise-æ¨¡å¼ä»¥å‰çš„ä¿¡ä»»é—®é¢˜è§£å†³æ–¹æ¡ˆ" class="sidebar-link">promise æ¨¡å¼ä»¥å‰çš„ä¿¡ä»»é—®é¢˜è§£å†³æ–¹æ¡ˆï¼š</a></li><li class="sidebar-sub-header"><a href="/frontend/javascript/promise_await_async/#promise" class="sidebar-link">promise</a></li><li class="sidebar-sub-header"><a href="/frontend/javascript/promise_await_async/#ç©¶å…¶åŸç†-æ‰‹å†™-promise" class="sidebar-link">ç©¶å…¶åŸç† æ‰‹å†™ promise</a></li><li class="sidebar-sub-header"><a href="/frontend/javascript/promise_await_async/#promise-çš„å±€é™æ€§æ˜¯ä»€ä¹ˆ" class="sidebar-link">promise çš„å±€é™æ€§æ˜¯ä»€ä¹ˆ</a></li><li class="sidebar-sub-header"><a href="/frontend/javascript/promise_await_async/#ç”Ÿæˆå™¨-æ‰“ç ´-function-å®Œæ•´è¿è¡Œçš„é­”æ³•" class="sidebar-link">ç”Ÿæˆå™¨ - æ‰“ç ´ function å®Œæ•´è¿è¡Œçš„é­”æ³•</a></li><li class="sidebar-sub-header"><a href="/frontend/javascript/promise_await_async/#for-of-å’Œç”Ÿæˆå™¨" class="sidebar-link">for - of å’Œç”Ÿæˆå™¨</a></li><li class="sidebar-sub-header"><a href="/frontend/javascript/promise_await_async/#promise-ç”Ÿæˆå™¨-å¼€å¯å¼‚æ­¥æ–°çºªå…ƒ" class="sidebar-link">promise + ç”Ÿæˆå™¨ -- å¼€å¯å¼‚æ­¥æ–°çºªå…ƒ</a></li><li class="sidebar-sub-header"><a href="/frontend/javascript/promise_await_async/#generator-runner-æ˜¯æ—¶å€™èåˆ-pormise-å’Œç”Ÿæˆå™¨äº†" class="sidebar-link">generator runner - æ˜¯æ—¶å€™èåˆ pormise å’Œç”Ÿæˆå™¨äº†ï¼ï¼ï¼</a></li><li class="sidebar-sub-header"><a href="/frontend/javascript/promise_await_async/#es7-ä¹‹-async-await-ä¼ è¯´ä¸­çš„å¼‚æ­¥ç»ˆæè§£å†³æ–¹æ¡ˆ-babel-å·²ç»æ”¯æŒ" class="sidebar-link">ES7 ä¹‹ async + await -- ä¼ è¯´ä¸­çš„å¼‚æ­¥ç»ˆæè§£å†³æ–¹æ¡ˆ ï¼ˆbabel å·²ç»æ”¯æŒï¼‰</a></li><li class="sidebar-sub-header"><a href="/frontend/javascript/promise_await_async/#ç›¸å¯¹äº-promise-æœ‰ä»€ä¹ˆä¼˜åŠ¿" class="sidebar-link">ç›¸å¯¹äº promise æœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ</a></li></ul></li><li><a href="/frontend/javascript/regex.html" class="sidebar-link">æ­£åˆ™è¡¨è¾¾å¼</a></li><li><a href="/frontend/javascript/base.html" class="sidebar-link">jsåŸºç¡€</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>css</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>browser</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>typescript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>nodejs</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>vuejs</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="promise-ç”Ÿæˆå™¨-await-async"><a href="#promise-ç”Ÿæˆå™¨-await-async" class="header-anchor">#</a> Promise &amp; ç”Ÿæˆå™¨ &amp; await async</h1> <h2 id="å¼‚æ­¥ç¼–ç¨‹æ ¸å¿ƒ-ç¨‹åºä¸­ç°åœ¨è¿è¡Œçš„éƒ¨åˆ†å’Œå°†æ¥è¿è¡Œçš„éƒ¨åˆ†ä¹‹é—´çš„å…³ç³»ã€‚"><a href="#å¼‚æ­¥ç¼–ç¨‹æ ¸å¿ƒ-ç¨‹åºä¸­ç°åœ¨è¿è¡Œçš„éƒ¨åˆ†å’Œå°†æ¥è¿è¡Œçš„éƒ¨åˆ†ä¹‹é—´çš„å…³ç³»ã€‚" class="header-anchor">#</a> å¼‚æ­¥ç¼–ç¨‹æ ¸å¿ƒï¼šç¨‹åºä¸­ç°åœ¨è¿è¡Œçš„éƒ¨åˆ†å’Œå°†æ¥è¿è¡Œçš„éƒ¨åˆ†ä¹‹é—´çš„å…³ç³»ã€‚</h2> <h2 id="å¼‚æ­¥æ“ä½œ-ä¾‹å­-log"><a href="#å¼‚æ­¥æ“ä½œ-ä¾‹å­-log" class="header-anchor">#</a> å¼‚æ­¥æ“ä½œï¼Œä¾‹å­ï¼š<code>log</code></h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token punctuation">{</span> idx<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  2 (å°‘æ•°æƒ…å†µä¸‹)</span>
a<span class="token punctuation">.</span>idx<span class="token operator">++</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>æ‰“å°æ˜¯ IO æ“ä½œï¼Œæ‰“å°åˆ°æ§åˆ¶å°æ˜¯ä½é€Ÿçš„é˜»å¡æ“ä½œã€‚æµè§ˆå™¨ä¸€èˆ¬é‡‡ç”¨å¼‚æ­¥å½¢å¼å»æ‰“å°ï¼Œåœ¨åå°å¼‚æ­¥å¤„ç†æ§åˆ¶å°çš„ IO æ“ä½œèƒ½å¤Ÿæé«˜æ€§èƒ½ã€‚ ä¹Ÿå°±æ˜¯è¯´<code>a.idx++</code>æœ‰å…ˆæ‰§è¡Œçš„å¯èƒ½æ€§ï¼Œç„¶å<code>log</code>å‡ºæ¥çš„å°±æ˜¯ 2ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹æ˜¯ç¼ºä¹å‡†ç¡®æ€§çš„ï¼Œæ›´ä¸ºç²¾ç¡®åœ°è°ƒè¯•æ–¹æ³•æ˜¯æ–­ç‚¹è°ƒè¯•ã€‚</p></blockquote> <h2 id="æµè§ˆå™¨çš„eventloop"><a href="#æµè§ˆå™¨çš„eventloop" class="header-anchor">#</a> æµè§ˆå™¨çš„<code>eventloop</code></h2> <blockquote><p>å¦‚æœå‘å‡ºä¸€ä¸ª Ajax è¯·æ±‚ï¼Œå¹¶åœ¨ä¸€ä¸ªå›è°ƒå‡½æ•°ä¸­è®¾ç½®å¥½å“åº”ä»£ç ï¼ŒJavaScript å¼•æ“ä¼šæš‚åœï¼ˆå½“å‰ï¼‰æ‰§è¡Œï¼Œç­‰å¾…å®¿ä¸»â€œå”¤é†’â€å›è°ƒï¼Œ ç„¶åæµè§ˆå™¨å°±ä¼šç›‘å¬æ¥è‡ªç½‘ç»œçš„å“åº”ï¼Œä¸€æ—¦å®Œæˆç½‘ç»œè¯·æ±‚ï¼Œå°±ä¼š <strong>æŠŠå›è°ƒå‡½æ•°æ’å…¥åˆ°äº‹ä»¶å¾ªç¯</strong>ï¼Œ
ä»¥æ­¤å®ç°å¯¹è¿™ä¸ªå›è°ƒçš„è°ƒåº¦æ‰§è¡Œã€‚é‚£ä»€ä¹ˆæ˜¯äº‹ä»¶å¾ªç¯ï¼Ÿ</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// V8è¿è¡Œç¯å¢ƒä¸‹ æœ‰å¾®ä»»åŠ¡é˜Ÿåˆ— åƒåœ¾å›æ”¶ uiæ¸²æŸ“é˜Ÿåˆ—...</span>
<span class="token keyword">const</span> global <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">micro</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">ui</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> eventLoop <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> event<span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// tick æ¯ä¸ªäº‹ä»¶å¾ªç¯å°±æ˜¯ä¸€ä¸ªtick</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>eventLoop<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    event <span class="token operator">=</span> eventLoop<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//FIFO</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">event</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      global<span class="token punctuation">.</span><span class="token function">micro</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      global<span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      global<span class="token punctuation">.</span><span class="token function">ui</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//global...</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// errHandler..</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>JavaScript å¼•æ“æœ¬èº«æ‰€åšçš„æ˜¯åœ¨éœ€è¦çš„æ—¶å€™æ‰§è¡Œç¨‹åºä¸­çš„å•ä¸ªä»£ç å—ã€‚JavaScript å¼•æ“å¹¶ä¸æ˜¯ç‹¬ç«‹è¿è¡Œçš„ï¼Œå®ƒè¿è¡Œåœ¨å®¿ä¸»ç¯å¢ƒä¸­ï¼Œæµè§ˆå™¨æˆ–æ˜¯<code>Node.js</code>æˆ–è€…å…¶ä»–çš„ç¯å¢ƒã€‚ä½†æ˜¯ï¼Œæ‰€æœ‰è¿™äº›ç¯å¢ƒéƒ½æœ‰ä¸€ä¸ªå…±åŒç‚¹,å®ƒä»¬éƒ½æä¾›äº†ä¸€ç§æœºåˆ¶æ¥å¤„ç†ç¨‹åºä¸­å¤šä¸ªå—çš„æ‰§è¡Œ, å®¿ä¸»å†³å®š js å¼•æ“å¦‚ä½•ä¸ºæˆ‘æ‰€ç”¨ï¼Œè¿™ç§æœºåˆ¶è¢«ç§°ä¸ºäº‹ä»¶å¾ªç¯ã€‚æ¢å¥è¯è¯´,JavaScript å¼•æ“æœ¬èº«å¹¶æ²¡æœ‰æ—¶é—´çš„æ¦‚å¿µï¼Œåªæ˜¯ä¸€ä¸ªæŒ‰éœ€æ‰§è¡Œ JavaScript ä»»æ„ä»£ç ç‰‡æ®µçš„<strong>å·¥å…·</strong>ã€‚äº‹ä»¶è°ƒåº¦æ€»æ˜¯ç”±åŒ…å«å®ƒçš„ç¯å¢ƒè¿›è¡Œï¼Œä»»åŠ¡æ˜¯å®¿ä¸»ç¯å¢ƒå®šä¹‰è°ƒç”¨æ—¶æœºçš„ï¼Œ<code>promise.then, timeout, web worker,raf,gc</code>ï¼Œä¹Ÿå°±æ˜¯è¯´ js å¼•æ“ä»€ä¹ˆæ—¶å€™å¼€å§‹æ‰§è¡Œä»£ç ï¼Œå®¿ä¸»è¯´äº†ç®—ï¼Œä¸åŒç¯å¢ƒä¸‹çš„äº‹ä»¶å¾ªç¯æœºåˆ¶ä¸åŒï¼Œä¾‹å¦‚<code>node</code>æˆ–æµè§ˆå™¨ã€‚ å¦‚ä¸‹ï¼šæµè§ˆå™¨äº‹ä»¶å¾ªç¯æœºåˆ¶ï¼š</p> <p>event loop çš„æ¯ä¸€æ­¥ï¼š<code>æ•´ä¸ªè„šæœ¬ä½œä¸ºç¬¬ä¸€ä¸ªå®ä»»åŠ¡ --&gt; å®ä»»åŠ¡å…¥æ ˆ --&gt; åŒæ­¥ä»£ç ç›´æ¥æ‰§è¡Œ --&gt; å½“å‰å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯• --&gt; æ£€æŸ¥å¾®ä»»åŠ¡é˜Ÿåˆ—å¹¶æ¸…ç©ºå¾®ä»»åŠ¡é˜Ÿåˆ— --&gt; æ‰§è¡Œuiæ¸²æŸ“è¿›ç¨‹æˆ–æ£€æŸ¥webworker --&gt; å®ä»»åŠ¡å…¥æ ˆ --&gt; æ‰§è¡Œä¸‹ä¸€ä¸ªå®ä»»åŠ¡çŸ¥é“æ¸…ç©ºå®ä»»åŠ¡æ ˆ</code></p> <p>web ä¸‹å®å¾®ä»»åŠ¡ï¼š</p> <p>å¾®é˜Ÿåˆ— =&gt; ç”±å¾®ä»»åŠ¡ç®—æ³•åˆ›å»ºçš„é˜Ÿåˆ—ï¼š<code>promise MutationObserver fetch-API</code>
å®é˜Ÿåˆ— =&gt; <code>ä¸»è¿›ç¨‹ setTimeout raf I/O</code></p></blockquote> <h2 id="å›è°ƒåœ°ç‹±"><a href="#å›è°ƒåœ°ç‹±" class="header-anchor">#</a> å›è°ƒåœ°ç‹±</h2> <blockquote><p>ç»å…¸å›è°ƒï¼Œæ•´ä¸ªæµç¨‹ä¸­éœ€è¦ä¸æ–­è·³æ¥è·³å»æŸ¥çœ‹ä»£ç è¿è¡Œæµç¨‹ï¼Œä»£ç å¤æ‚åº¦è¶Šé«˜ï¼Œè¿½è¸ªéš¾åº¦è¶Šå¤§</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">data</span><span class="token punctuation">(</span><span class="token parameter">param<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      url<span class="token operator">:</span> <span class="token string">&quot;url2&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">data</span><span class="token punctuation">(</span><span class="token string">&quot;url1&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ret1</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">data</span><span class="token punctuation">(</span>ret1<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ret2</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">data</span><span class="token punctuation">(</span>ret2<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ret3</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">//....</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">data</span><span class="token punctuation">(</span>ret1<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ret4</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">data</span><span class="token punctuation">(</span>ret4<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ret5</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">//....</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="zalgo-in-hell-åœ°ç‹±ä¸­çš„æ¶é­”-ä¿¡ä»»é—®é¢˜"><a href="#zalgo-in-hell-åœ°ç‹±ä¸­çš„æ¶é­”-ä¿¡ä»»é—®é¢˜" class="header-anchor">#</a> Zalgo in hell åœ°ç‹±ä¸­çš„æ¶é­” - ä¿¡ä»»é—®é¢˜</h2> <blockquote><p>å›è°ƒç­‰åŒäºæ˜¯å°†è‡ªå·±ä»£ç äº¤ç»™å·¥å…·ã€åº“å»ä»£ç†æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯å¹³æ—¶è¯´çš„æ§åˆ¶ç¿»è½¬ (IOC),åº“å†…éƒ¨çš„ä»£ç å¯¹ä½ æ˜¯ä¸å¯è§çš„ã€‚å½“å­˜åœ¨ä¿¡ä»»é—®é¢˜çš„æ—¶å€™ï¼Œå°†éœ€è¦è‡ªå·±å»ç¡®è®¤å¾ˆå¤šå®‰å…¨æ£€æŸ¥å»é¿å…å¼‚å¸¸ï¼Œé¿å…å¯¼è‡´å¾ˆä¸¥é‡çš„é—®é¢˜ã€‚</p></blockquote> <ul><li><p>ä¸ä¿¡ä»»çš„å¾ˆå¤šç§æƒ…å†µï¼š</p> <ol><li>å›è°ƒä½¿ç”¨è¿‡æ—©ç”šè‡³åŒæ­¥ä»£</li> <li>å›è°ƒä½¿ç”¨è¿‡æ™šç”šè‡³ä¸ä¼šè°ƒç”¨</li> <li>å›è°ƒæ¬¡æ•°ä¸åˆç†ç”šè‡³å¤šæ¬¡è°ƒç”¨(å°¤å…¶å¯¹äºæŸäº›ä»˜æ¬¾äº¤æ˜“)</li> <li>å‚æ•°ä¼ é€’é—®é¢˜ä¸å›ä¼ é‡è¦å‚æ•°å¯¼è‡´ç¨‹åºæŠ¥é”™</li> <li>æ½œåœ¨çš„ bug æœªä½œå¤„ç†ï¼Œå¼‚å¸¸å¤„ç†è„†å¼±ï¼Œå›è°ƒçš„æŸä¸€çº§å‡ºé”™ä¹‹åï¼Œåç»­ä»»åŠ¡å°†ä¼šæ°¸è¿œè·‘ä¸åˆ°ï¼Œä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œéœ€è¦åœ¨æ¯ä¸€ä¸ªæ­¥éª¤ä¸­æ·»åŠ å¼‚å¸¸å¤„ç†ä»£ç ã€‚å‰ææ˜¯ï¼šä½ å¾—çŸ¥é“å“ªæŠ¥é”™ï¼Œå¹¶ä¸”æ˜ç™½æ€ä¹ˆå¤„ç†è¿™äº›å¼‚å¸¸ï¼Œå½“ç„¶å­˜åœ¨æŸäº›æç«¯æƒ…å†µä¸‹æŸäº›ä»£ç ä¼šæŠ¥é”™ï¼Œå½“ç¼–ç è€…å¹¶ä¸æ¸…æ¥šæŸä¸ªåœ°æ–¹å­˜åœ¨ bug çš„æ—¶å€™å°†æ— æ³•é€šè¿‡ç¡¬ç¼–ç å»æ•è·è¿™ä¸ªé”™è¯¯ï¼Œç›´åˆ°çº¿ä¸Šå‡ºç°é‡å¤§é—®é¢˜ï¼Œå¯¹äºè¿™äº›æ²¡æœ‰å¤„ç†çš„æ½œåœ¨çš„ bugï¼Œå°±æ˜¯ä½ æ”¾å‡ºçš„æ¶é­”ã€‚ ï¼ˆrelease Zalgoï¼‰</li></ol></li></ul> <h2 id="promise-æ¨¡å¼ä»¥å‰çš„ä¿¡ä»»é—®é¢˜è§£å†³æ–¹æ¡ˆ"><a href="#promise-æ¨¡å¼ä»¥å‰çš„ä¿¡ä»»é—®é¢˜è§£å†³æ–¹æ¡ˆ" class="header-anchor">#</a> promise æ¨¡å¼ä»¥å‰çš„ä¿¡ä»»é—®é¢˜è§£å†³æ–¹æ¡ˆï¼š</h2> <blockquote><p>è¿™ä¸¤ç§æ–¹æ¡ˆæœªä»æ ¹æœ¬ä¸Šè§£å†³é—®é¢˜ï¼Œåˆ†ç¦»æ¨¡å¼ç”šè‡³éœ€è¦ç”¨æˆ·ä¼ å…¥ä¸¤å¥—ä»£ç å»åº”å¯¹ä¸åŒçš„æƒ…å†µï¼Œerr-first ä¹ŸåŒæ ·éœ€è¦å»åš node é£æ ¼çš„ err æ ¡éªŒã€‚ <strong>ç¹çã€‚</strong></p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// - 1. æˆåŠŸã€å¤±è´¥åˆ†ç¦»æ¨¡å¼</span>
<span class="token keyword">function</span> <span class="token function">data</span><span class="token punctuation">(</span><span class="token parameter">param<span class="token punctuation">,</span> success<span class="token punctuation">,</span> failed</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;...&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">success</span><span class="token punctuation">(</span><span class="token string">&quot;success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">failed</span><span class="token punctuation">(</span><span class="token string">&quot;err&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// - 2. error-first é£æ ¼ï¼ˆnodejsé£æ ¼ï¼‰</span>
<span class="token keyword">function</span> <span class="token function">data</span><span class="token punctuation">(</span><span class="token parameter">param<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> err<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;...&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;zalgo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å°†é”™è¯¯ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="promise"><a href="#promise" class="header-anchor">#</a> promise</h2> <blockquote><p>promise æœ¬è´¨ä¸Šä¹Ÿæ˜¯å›è°ƒï¼Œåªä¸è¿‡ä¿®æ”¹äº†å›è°ƒçš„ä¼ å…¥å’Œä½¿ç”¨æ–¹å¼</p></blockquote> <ul><li><p>æ¥ä¸‹æ¥å…·ä½“çœ‹ä¸€ä¸‹ promise æ˜¯å¦‚ä½•å¤„ç†ä¼ ç»Ÿå›è°ƒä¸­çš„ä¿¡ä»»é—®é¢˜çš„:</p> <ol><li><p>è°ƒç”¨è¿‡æ—©ï¼šæ°¸è¿œå¼‚æ­¥è°ƒç”¨ï¼Œæ°¸è¿œé€šè¿‡ <code>Promise.resolve()</code> è¿›è¡Œä¸€æ¬¡æ ‡å‡†åŒ–ã€‚</p></li> <li><p>è°ƒç”¨è¿‡æ™šæˆ–è€…æ ¹æœ¬æ²¡æœ‰è°ƒç”¨ï¼šè®¾ç½®è¶…æ—¶æ—¶é—´åŠåº”å¯¹æ–¹æ¡ˆ<code>Promise.race([timeoutPromise,Promise])</code></p></li> <li><p>è°ƒç”¨æ¬¡æ•°è¿‡å¤šï¼šå•å†³è®®ï¼Œæ¯ä¸ª promise åªèƒ½è¿›è¡Œä¸€æ¬¡å†³è®®ï¼Œä¸”çŠ¶æ€æ— æ³•å›é€€ã€‚</p> <p>å¯¹äºä¸å¯ä¿¡ä»»çš„ thenableï¼Œä¹Ÿå¯ä»¥é€šè¿‡ Promise.resolve()å»è¿›è¡Œæ ‡å‡†åŒ–ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> thenable <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">,</span> rej</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">res</span><span class="token punctuation">(</span><span class="token string">&quot;æˆ‘å†³è®®äº†&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">rej</span><span class="token punctuation">(</span><span class="token string">&quot;æˆ‘åˆæ‹’ç»äº†&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è¿™ä¸ªä¸æ ‡å‡†çš„thenableå¯¹è±¡ä¼šå†³è®®ä¸¤æ¬¡ è¿™æ˜¯ä¸ç¬¦åˆpromiseè§„èŒƒçš„</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
thenable<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> err<span class="token punctuation">;</span> <span class="token comment">//è¿™é‡Œä¹Ÿä¼šæ‰§è¡Œåˆ°</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ***************æŠŠ thenable è½¬æ¢æˆä»…ä»…èƒ½å†³è®®ä¸€æ¬¡çš„è§„èŒƒåŒ–çš„promise*********************</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>thenable<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> err<span class="token punctuation">;</span> <span class="token comment">//è¿™é‡Œç»å¯¹ä¸ä¼šæ‰§è¡Œåˆ°</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">,</span> rej</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  thenable<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> rej<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>å‚æ•°ä¼ é€’ï¼šåŒä¸€å°è£…åˆ°ä¸€ä¸ªå†³è®®å€¼ï¼Œæœªä¼ å°±æ˜¯ undefined</p></li> <li><p>æ½œåœ¨çš„ bug å¤„ç†ï¼šä½¿ç”¨ catchï¼Œé€šè¿‡é”™è¯¯å†’æ³¡å»å¤„ç†é”™è¯¯ã€‚</p></li></ol></li></ul> <h2 id="ç©¶å…¶åŸç†-æ‰‹å†™-promise"><a href="#ç©¶å…¶åŸç†-æ‰‹å†™-promise" class="header-anchor">#</a> ç©¶å…¶åŸç† æ‰‹å†™ promise</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// new ():IPromise</span>
<span class="token comment">// then</span>
<span class="token comment">// catch</span>
<span class="token comment">// finally</span>
<span class="token comment">// static resolve</span>
<span class="token comment">// static reject</span>
<span class="token comment">// static all</span>
<span class="token comment">// static race</span>
<span class="token keyword">let</span> id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">IPromise</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> states <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;pending&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;resolved&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rejected&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token operator">++</span>id<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>resfns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>rejfns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>stat <span class="token operator">=</span> states<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>val <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>err <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">res</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¿›è¡Œå†³è®® ç„¶åå»flushå›è°ƒå‡½æ•°æ•°ç»„</span>
    <span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>stat <span class="token operator">===</span> <span class="token string">&quot;pending&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span>val <span class="token operator">=</span> val<span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>stat <span class="token operator">=</span> states<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>resfns<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          self<span class="token punctuation">.</span>val <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> self<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">rej</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>stat <span class="token operator">===</span> <span class="token string">&quot;pending&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span>err <span class="token operator">=</span> err<span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>stat <span class="token operator">=</span> states<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>rejfns<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">fn</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> rej<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">IPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">then</span><span class="token punctuation">(</span>
  <span class="token function-variable function">onresd</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">,</span>
  <span class="token function-variable function">onrejd</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>stat <span class="token operator">===</span> <span class="token string">&quot;pending&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åŒæ­¥æ·»åŠ å›è°ƒ  å¼‚æ­¥ç­‰å¾…å›è°ƒ ç­‰å¾…å½“å‰promise res()ä¹‹åæ‰§è¡Œå›è°ƒ</span>
    <span class="token keyword">const</span> temp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">,</span> rej</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœselfå°šæœªå†³è®® è¿”å›ä¸€ä¸ªæ–°çš„promsie</span>
      <span class="token comment">// å½“å‰selfåˆ†åˆ«ä¼ å…¥å¯¹åº”çŠ¶æ€çš„å›è°ƒå‡½æ•° res rej</span>
      <span class="token comment">// å½“å‰selfä¸­ä¼ å…¥çš„å›è°ƒ,å›è°ƒé¦–å…ˆæ‰§è¡Œå½“å‰thenä¸­ä¼ å…¥çš„æ–¹æ³• onresd onrejd (promise å†…éƒ¨åŒæ­¥æ‰§è¡Œ)</span>
      <span class="token comment">// å°†å½“å‰fn fn2çš„è¿”å›å€¼ **é€ä¼ ** ç»™äº†å½“å‰æ–°çš„promise tempçš„è‡ªå·±çš„å›è°ƒå‡½æ•°ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰</span>
      <span class="token comment">// temp.then('è¿™é‡Œå°†è·å¾—fnçš„ç»“æœ').catch('è¿™é‡Œè®²è·å¾—fn2çš„ç»“æœ')</span>
      <span class="token comment">// ä»¥ä¸‹å†…å®¹åŒæ­¥æ‰§è¡Œ</span>
      self<span class="token punctuation">.</span>resfns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä¼ å…¥self.res(val)æ—¶å€™æ‰§è¡Œçš„å›è°ƒ ï¼Œå›è°ƒä¸­è§¦å‘äº†temp.res() å®ç°é“¾å¼è°ƒç”¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token keyword">instanceof</span> <span class="token class-name">IPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          val<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// å¦‚æœå½“å‰æ˜¯ thenable å°±é€šè¿‡ .then() è¿›è¡Œä¸€æ¬¡è„±å£³æ“ä½œ å–åˆ°è¿”å›å€¼å¹¶é€ä¼  ï¼ˆå¦‚æœè¿”å›å€¼è¿˜æ˜¯promiseè¿˜éœ€ä¸€ç›´è„±å£³ æ‡’å¾—å†™ å°±å…ˆæ•´ä¸€å±‚è„±å£³ï¼‰</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token function">res</span><span class="token punctuation">(</span><span class="token function">onresd</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">rej</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> ret <span class="token operator">=</span> <span class="token function">onresd</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ­¤æ—¶æ‰§è¡Œselfçš„then()ä¸­ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‡½æ•°ï¼Œå¾—åˆ°è¿”å›å€¼ ret</span>
            <span class="token function">res</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é€šè¿‡tempçš„res()å»æ‰§è¡Œtempçš„å›è°ƒ,å¹¶ä¸”å°†retä¼ é€’ç»™ä¸‹ä¸€ä¸ª then(onresd(ret)) ,è¿™å°±æ˜¯å€¼çš„é€ä¼  å¼€å¯ä¸‹ä¸€ä¸ªthen()</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">rej</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ¥é”™ å°±æ‰§è¡Œä¸‹ä¸€ä¸ªpromiseçš„é”™è¯¯å¤„ç†å›è°ƒ è¿™å°±æ˜¯é”™è¯¯çš„å†’æ³¡</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      self<span class="token punctuation">.</span>rejfns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä¼ å…¥é”™è¯¯å¤„ç†å›è°ƒ</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> ret <span class="token operator">=</span> <span class="token function">onrejd</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ­¤å¤„ä¼šä¸æ–­å°†é”™è¯¯å†’æ³¡</span>
          <span class="token function">res</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ‰§è¡Œé”™è¯¯å¤„ç†æ–¹æ³• å¦‚æœæœªä¼ å…¥ é»˜è®¤ç›´æ¥æŠ›å‡ºå½“å‰é”™è¯¯ å°†é”™è¯¯å¤„ç†ç»“æœä¼ åˆ°ä¸‹ä¸€ä¸ªpromiseçš„thenæ–¹æ³•ä¸­å» ä¹Ÿå°±æ˜¯æ¯æ¬¡å¤„ç†å®Œé”™è¯¯éƒ½å›å½’æ­£å¸¸æµç¨‹</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// å¦‚æœæœªä½œå¤„ç† ç›´æ¥æŠ›é”™ å†’æ³¡åˆ°ä¸‹ä¸€ä¸ªthen(null,onrejd)æˆ–catch(onrejd)</span>
          <span class="token function">rej</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> temp<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>stat <span class="token operator">===</span> <span class="token string">&quot;resolved&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">onresd</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">onrejd</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token class-name">IPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">catch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">cat</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token class-name">IPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">finally</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">final</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">isFunction</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">isFn</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">typeof</span> a <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

IPromise<span class="token punctuation">.</span><span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token keyword">instanceof</span> <span class="token class-name">IPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ£€æŸ¥promise</span>
    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">&amp;&amp;</span> val<span class="token punctuation">.</span>then <span class="token operator">&amp;&amp;</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>val<span class="token punctuation">.</span>then<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ ¹æ®é¸­å­ç†è®ºå»æ£€æŸ¥thenableç±»å‹</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">IPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">,</span> rej</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      val<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> rej<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">IPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">res</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

IPromise<span class="token punctuation">.</span><span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">IPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">,</span> rej</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">rej</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

IPromise<span class="token punctuation">.</span><span class="token function-variable function">all</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">all</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> promises <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">promise</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> promise <span class="token keyword">instanceof</span> <span class="token class-name">IPromise</span> <span class="token operator">?</span> promise <span class="token operator">:</span> IPromise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> len <span class="token operator">=</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">IPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">,</span> rej</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> resArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      promises<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">i<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        i<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          resArr<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> r<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>len <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">res</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">...</span>resArr<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">rej</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

IPromise<span class="token punctuation">.</span><span class="token function-variable function">race</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">race</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> promises <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">promise</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> promise <span class="token keyword">instanceof</span> <span class="token class-name">IPromise</span> <span class="token operator">?</span> promise <span class="token operator">:</span> IPromise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">IPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">,</span> rej</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      promises<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">i<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        i<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token function">res</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">rej</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">f0</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// f0.res() =&gt; p1.res()</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">res</span><span class="token punctuation">(</span><span class="token string">&quot;start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> p2 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// p1.then()è¿”å›æ–°çš„promise p2ï¼Œp1çš„å›è°ƒä¼šæ‰§è¡Œp2çš„res()</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;then 1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> p3 <span class="token operator">=</span> p2<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">f2</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;then 2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> p4 <span class="token operator">=</span> p3<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">f3</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token string">&quot;then 3&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> p5 <span class="token operator">=</span> p4<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">f4</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;err : &quot;</span> <span class="token operator">+</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

p5<span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;shut src&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

IPromise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token keyword">new</span> <span class="token class-name">IPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">res</span><span class="token punctuation">(</span><span class="token string">&quot;123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token number">3</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

IPromise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token keyword">new</span> <span class="token class-name">IPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">res</span><span class="token punctuation">(</span><span class="token string">&quot;123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token number">3</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="promise-çš„å±€é™æ€§æ˜¯ä»€ä¹ˆ"><a href="#promise-çš„å±€é™æ€§æ˜¯ä»€ä¹ˆ" class="header-anchor">#</a> promise çš„å±€é™æ€§æ˜¯ä»€ä¹ˆ</h2> <ol><li>å¦‚æœä¸€å¼€å§‹å°±é”™è¯¯çš„ä½¿ç”¨ promise-API å°±æ— æ³•åœ¨ rej ä¸­æ•è·é”™è¯¯ ä¾‹å¦‚ new Promise(null) || Promise.race(1)ã€‚</li> <li>å½“åŒä¸€ä¸ª promise æ‹¥æœ‰å¤šä¸ª res å†³è®®æˆ–è€… rej å†³è®®çš„æ—¶å€™ï¼Œå¦‚æœå†³è®®è¿‡ç¨‹ä¸­æŠ¥é”™ï¼Œå¯èƒ½ä¼šé€ æˆæœ‰çš„å›è°ƒæ‰§è¡Œäº†ï¼Œæœ‰çš„å›è°ƒæ²¡æ‰§è¡Œã€‚</li> <li>æ— æ³•å–æ¶ˆçš„ promiseï¼Œ<code>Promise.race([timeoutPromsie,p])</code> å‡è®¾è¶…æ—¶å¾ˆè‡ªç„¶ä¼šæ‰§è¡Œ timeoutPromiseï¼Œä½†æ˜¯ p çš„æ‰§è¡Œä¸ä¼šä¸­æ–­ï¼Œç”šè‡³è¿˜æ˜¯æ‰§è¡Œ p.then()ï¼Œè¿™å®é™…ä¸Šå’ŒæœŸæœ›æ˜¯ä¸ä¸€è‡´çš„ã€‚å°±åƒæŸä¸ªåŠ¨ä½œè¶…æ—¶äº†ï¼Œå…¶åç»­åŠ¨ä½œåº”è¯¥åœæ­¢ï¼</li> <li>å¼‚æ­¥é”™è¯¯æ— æ³•åŒæ­¥æ•è·ï¼ˆä¼ ç»Ÿå›è°ƒä¹Ÿæœ‰è¿™ä¸ªé—®é¢˜ï¼‰ã€‚</li> <li>åœ¨ promise é“¾ä¸­çš„æœ€åä¸€æ­¥çš„æŠ¥é”™æ— æ³•é¢„æµ‹ï¼Œè¿™å®é™…ä¸Šæ˜¯ä¸ªæ— åº•æ´ã€‚</li> <li>é¡ºåºé”™è¯¯å¤„ç†ï¼Œpromise çš„é“¾å¼è°ƒç”¨ï¼Œæ–¹ä¾¿ä½†åŒæ—¶å®šä½å…·ä½“æŸä¸ªé“¾èŠ‚å‡ºé”™çš„æ—¶å€™æ¯”è¾ƒéš¾ã€‚(ä»¥é“¾å¼çš„ç¼–ç ä¹ æƒ¯æ¥è¯´ï¼Œæ— æ³•ä¸ºä¸­é—´çš„æ¯ä¸ªé“¾æ¥å»æ·»åŠ é”™è¯¯å¤„ç†æ–¹æ³•)ã€‚</li></ol> <h2 id="ç”Ÿæˆå™¨-æ‰“ç ´-function-å®Œæ•´è¿è¡Œçš„é­”æ³•"><a href="#ç”Ÿæˆå™¨-æ‰“ç ´-function-å®Œæ•´è¿è¡Œçš„é­”æ³•" class="header-anchor">#</a> ç”Ÿæˆå™¨ - æ‰“ç ´ function å®Œæ•´è¿è¡Œçš„é­”æ³•</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token parameter">some</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> ret <span class="token operator">=</span> some <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">yield</span> <span class="token operator">++</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;ret : &quot;</span> <span class="token operator">+</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> iterable <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token string">&quot;pre***************&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> now <span class="token operator">=</span> iterable<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token string">&quot;start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å¯åŠ¨è¿™ä¸ªç”Ÿæˆå™¨ï¼ ä½†startå°†è¢«ä¸¢å¼ƒã€‚</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>now<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1 yieldå°†åè¾¹è¡¨è¾¾å¼çš„å€¼ä¼ ç»™äº†next()  { value: 1, done: false }</span>
now <span class="token operator">=</span> iterable<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token string">&quot;next 1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>now<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
now <span class="token operator">=</span> iterable<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token string">&quot;next 2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>now<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>

iterable<span class="token punctuation">.</span><span class="token function">return</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// åœæ­¢è¿­ä»£</span>
iterable<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æŠ›å‡ºè¿­ä»£å™¨é”™è¯¯ error</span>
</code></pre></div><blockquote><p>å…³äºç”Ÿæˆå™¨è¿è¡Œæ—¶çš„å‡ ä¸ªæ³¨æ„ç‚¹</p> <ol start="0"><li><p>ç”Ÿæˆå™¨ä»…ä»…æš‚åœäº†è‡ªèº«çš„ä»£ç ï¼Œä¸å½±å“æ•´ä½“è¿è¡Œã€‚</p></li> <li><p>gen()ä»…ä»…åˆ›å»ºäº†ä¸€ä¸ªè¿­ä»£å™¨ è€Œä¸æ˜¯è¿è¡Œç”Ÿæˆå™¨ä¸­çš„æ–¹æ³•</p></li> <li><p>ç”Ÿæˆå™¨å°†ä¼šå»ºç«‹ yield å’Œ next ä¹‹é—´çš„ <strong><em>åŒå‘æ•°æ®é€šè·¯</em></strong></p> <ul><li>next å°†æ•°æ®ä¼ é€’ç»™ yield æ‰€å¤„çš„è¡¨è¾¾å¼</li> <li>yield å°†æ•°æ®å›ä¼ ç»™ next æ–¹æ³•çš„è¿”å›å€¼</li></ul></li> <li><p>è¿­ä»£å™¨çš„ç¬¬ä¸€ä¸ª next æ°¸è¿œæ˜¯å¼€å¯è¿™ä¸ªç”Ÿæˆå™¨ï¼Œè¿è¡Œåˆ°ç¬¬ä¸€ä¸ª yield åœæ­¢ï¼ˆå¹¶æŠŠç¬¬ä¸€ä¸ª yield åçš„è¡¨è¾¾å¼çš„è¿ç®—å€¼æ‹¿å›æ¥ï¼‰.</p></li> <li><p>ç¬¬ä¸€ä¸ª next(param)ä¸­çš„å‚æ•° param ä¼šè¢«ä¸¢å¼ƒã€‚åç»­çš„ next æ‰ä¼šä¼ é€’æ•°æ®åˆ° yield æ‰€åœ¨çš„è¡¨è¾¾å¼ä¸­å»ã€‚</p></li> <li><p>ç”Ÿæˆå™¨å¯ä»¥æ°¸è¿œä¸æ‰§è¡Œå®Œæ¯• ï¼ˆæ°¸è¿œå¤„äºä¸€ä¸ªæš‚åœçš„çŠ¶æ€ï¼‰</p></li> <li><p>å¯¹äºå¯æ‰§è¡Œå®Œæ¯•çš„ç”Ÿæˆå™¨ æœ€åä¸€ä¸ª next å°†æ‹¿åˆ° return çš„ç»“æœ æœªè®¾ç½® è¿”å›å€¼çš„ value å±æ€§ä¸º undefined</p></li> <li><p>å¤–éƒ¨é€šè¿‡è°ƒç”¨è¿­ä»£å™¨çš„æ–¹æ³•åœæ­¢ä¸€ä¸ªè¿­ä»£å™¨ iterable.return()</p></li> <li><p>å¤–éƒ¨é€šè¿‡è°ƒç”¨è¿­ä»£å™¨çš„æ–¹æ³•ä½¿è¿­ä»£å™¨æŠ›å‡ºé”™è¯¯ iterable.throw()</p></li></ol></blockquote> <h2 id="for-of-å’Œç”Ÿæˆå™¨"><a href="#for-of-å’Œç”Ÿæˆå™¨" class="header-anchor">#</a> for - of å’Œç”Ÿæˆå™¨</h2> <blockquote><p>for of ä¼šå±•å¼€å¯è¿­ä»£å¯¹è±¡ï¼Œå¯è¿­ä»£å¯¹è±¡æœ‰ä¸¤ä¸ªç‰¹ç‚¹</p> <ul><li>[Symbol.iterator]() è¿”å›ä¸€ä¸ªè¿­ä»£å™¨ç”¨äº for-of å¾ªç¯ä½¿ç”¨</li> <li>next()æ–¹æ³• è¿”å›æ¯ä¸€æ¬¡è¿­ä»£çš„ç»“æœ</li></ul></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// æ‰‹åŠ¨å»åˆ›å»ºä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡</span>
<span class="token keyword">const</span> iterable <span class="token operator">=</span> <span class="token punctuation">{</span>
  val<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å»è¿­ä»£å½“å‰çš„è¿­ä»£å™¨</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>val <span class="token operator">&lt;</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        done<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        value<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>val <span class="token operator">+=</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        done<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        value<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>val<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–ä¸€ä¸ªè¿­ä»£å™¨</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//ç”¨ç”Ÿæˆå™¨å»è½»æ¾åˆ›å»ºä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡</span>
<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">&lt;</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">yield</span> <span class="token punctuation">(</span>val <span class="token operator">+=</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> val<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> item <span class="token keyword">of</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="promise-ç”Ÿæˆå™¨-å¼€å¯å¼‚æ­¥æ–°çºªå…ƒ"><a href="#promise-ç”Ÿæˆå™¨-å¼€å¯å¼‚æ­¥æ–°çºªå…ƒ" class="header-anchor">#</a> promise + ç”Ÿæˆå™¨ -- å¼€å¯å¼‚æ­¥æ–°çºªå…ƒ</h2> <blockquote><p>åŒæ­¥æ•è·é”™è¯¯å¤„ç†ï¼Œè¯•æƒ³ä»¥ä¸‹ä¸¤æ®µä»£ç ï¼š</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// åŒæ­¥å†™æ³•</span>
<span class="token keyword">function</span> <span class="token function">data$</span><span class="token punctuation">(</span><span class="token parameter">p1<span class="token punctuation">,</span> p2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> p1<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> p2<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> e<span class="token punctuation">;</span> <span class="token comment">// å°†é”™è¯¯ä»å†…éƒ¨æŠ›å‡º</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token parameter">p1<span class="token punctuation">,</span> p2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> text <span class="token operator">=</span> <span class="token function">data$</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//undefined ä¸å¯èƒ½è·å–åˆ°å¼‚æ­¥æ•°æ®</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ä¹Ÿä¸èƒ½æ•è·å¼‚æ­¥é”™è¯¯</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">getData</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// å›è°ƒå†™æ³•</span>
<span class="token keyword">function</span> <span class="token function">data$</span><span class="token punctuation">(</span><span class="token parameter">p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">cb</span><span class="token punctuation">(</span>p1<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> p2<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//å›ä¼ æ•°æ®</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> e<span class="token punctuation">;</span> <span class="token comment">// å°†é”™è¯¯ä»å†…éƒ¨æŠ›å‡º</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token parameter">p1<span class="token punctuation">,</span> p2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">data$</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// èƒ½å¾—åˆ°æ•°æ®</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ä¹Ÿä¸èƒ½æ•è·å¼‚æ­¥é”™è¯¯</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">getData</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// promise</span>
<span class="token keyword">function</span> <span class="token function">data$</span><span class="token punctuation">(</span><span class="token parameter">p1<span class="token punctuation">,</span> p2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">,</span> rej</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">res</span><span class="token punctuation">(</span>p1<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> p2<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span> <span class="token comment">// å°†é”™è¯¯ä»å†…éƒ¨æŠ›å‡º</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token parameter">p1<span class="token punctuation">,</span> p2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">data$</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ä¹Ÿä¸èƒ½æ•è·å¼‚æ­¥é”™è¯¯</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">getData</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>åŠ å…¥ç”Ÿæˆå™¨ï¼Œè®©ç”Ÿæˆå™¨å»ä»£ç†ä»£ç çš„æ‰§è¡Œå’Œé”™è¯¯çš„å¤„ç†ï¼š<strong>ç”Ÿæˆå™¨ yield æš‚åœçš„ç‰¹æ€§æ„å‘³ç€ä¸ä»…èƒ½å¤Ÿä»å¼‚æ­¥å‡½æ•°è°ƒç”¨å¾—åˆ°çœ‹ä¼¼åŒæ­¥çš„è¿”å›å€¼ï¼Œè¿˜å¯ä»¥åŒæ­¥æ•è·æ¥è‡ªè¿™äº›å¼‚æ­¥å‡½æ•°è°ƒç”¨çš„é”™è¯¯ã€‚</strong></p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">data$</span><span class="token punctuation">(</span><span class="token parameter">p1<span class="token punctuation">,</span> p2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>p1<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> p2<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç”Ÿæˆå™¨å°†æ•°æ®å›ä¼ </span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      iterator<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç”Ÿæˆå™¨å°†é”™è¯¯ä»å†…éƒ¨æŠ›åˆ°å¤–å±‚ï¼</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token parameter">p1<span class="token punctuation">,</span> p2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> text <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">data$</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å¯ä»¥çœ‹ä½œæ˜¯ç­‰å¾…data$æ‰§è¡Œå®Œæˆ</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// çœ‹ä¼¼æ˜¯åŒæ­¥çš„ä»£ç  æ²¡æœ‰å›è°ƒ ä¹Ÿæ²¡æœ‰promise.then</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// catchåˆ°äº†ï¼ æ•è·åˆ°äº†å¼‚æ­¥çš„é”™è¯¯ã€‚</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> iterator <span class="token operator">=</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è·å–è¿­ä»£å™¨</span>
iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å¯åŠ¨ å°†ä»£ç çš„è¿è¡Œäº¤ç»™ç”Ÿæˆå™¨</span>
</code></pre></div><h2 id="generator-runner-æ˜¯æ—¶å€™èåˆ-pormise-å’Œç”Ÿæˆå™¨äº†"><a href="#generator-runner-æ˜¯æ—¶å€™èåˆ-pormise-å’Œç”Ÿæˆå™¨äº†" class="header-anchor">#</a> <code>generator runner</code> - æ˜¯æ—¶å€™èåˆ pormise å’Œç”Ÿæˆå™¨äº†ï¼ï¼ï¼</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// æŠŠå‡½æ•°çš„è¿”å›å€¼ä¿®æ”¹æˆè¿”å›promiseçš„å½¢å¼</span>
<span class="token comment">// calc(1,2)=&gt;3</span>
<span class="token comment">// é€šè¿‡wrapä¹‹å Promise.wrap(calc) =&gt; calcWrapped</span>
<span class="token comment">// calcWrapped(1,2).then(data =&gt; console.log(data) //3 )</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Promise<span class="token punctuation">.</span>wrap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Promise<span class="token punctuation">.</span><span class="token function-variable function">wrap</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">calc</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> sum <span class="token operator">=</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sum <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> sum<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;ERROR **** bigger than 10&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * run ä»£ç†ä¸€å€‹ç”Ÿæˆå™¨,å¸®åŠ©æ‹¦æˆªç”Ÿæˆå™¨è¿”å›ç»“æœå¹¶ä¼ å…¥promiseçš„å†³è®®å€¼
 * å…¥å‚æ˜¯ä¸€ä¸ªç”Ÿæˆå™¨ è¿”å›ä¸€ä¸ªpromiseï¼Œå›ä¼ ç”Ÿæˆå™¨***æœ€ç»ˆ***çš„returnå€¼
 * @param {Generator}
 * @return {Promise}
 */</span>
<span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token parameter">gen</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// åç»­å‚æ•°èµ‹å€¼ç»™ç”Ÿæˆå™¨ run(gen,param1,param2...)</span>
  <span class="token keyword">let</span> it <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å¾—åˆ°å½“å‰è¿­ä»£å™¨</span>

  <span class="token keyword">function</span> <span class="token function">handleError</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¿™é‡Œå°†é”™è¯¯é€šè¿‡ç”Ÿæˆå™¨çš„æ–¹æ³•æŠ›å‡º æ‰€ä»¥èƒ½åœ¨ç”Ÿæˆå™¨å†…éƒ¨åŒæ­¥catchåˆ°</span>
    <span class="token comment">// å¤–å±‚catchåˆ°é”™è¯¯å¤„ç†å®Œæ¯•ä¹‹åä¼šç»§ç»­è¿è¡Œåˆ°ä¸‹ä¸€ä¸ªyieldå¤„</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>handleResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleResult</span><span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//  æ¯æ¬¡éƒ½æ‹¿åˆ° {value:any,done:Boolean}</span>
    <span class="token comment">// épromiseæ ‡å‡†åŒ–æˆpromiseï¼ˆä¸»è¦æ˜¯ä¸ºäº†é’ˆå¯¹æŸäº›ç”Ÿæˆå™¨å†…éƒ¨æ²¡æœ‰yieldå…³é”®å­—ï¼‰</span>
    next<span class="token punctuation">.</span>value <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// åˆ¤æ–­ç”Ÿæˆå™¨çŠ¶æ€ å¦‚æœå®Œæˆäº† ç›´æ¥è¿”å›å€¼</span>
      <span class="token keyword">return</span> next<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦åˆ™ç»§ç»­è¿­ä»£ç”Ÿæˆå™¨ è·å–ä¸­é—´æ•°æ®</span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>handleNext<span class="token punctuation">,</span> handleError<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleNext</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ ¸å¿ƒ</span>
    <span class="token comment">// it.next(val)ä¼šé¦–å…ˆæŠŠvalä¼ ç»™yieldæ‰€åœ¨çš„è¡¨è¾¾å¼ (å¯åŠ¨æ—¶ç”Ÿæˆå™¨ä¼šè‡ªåŠ¨å¿½ç•¥è¯¥å€¼)</span>
    <span class="token comment">// ç„¶åç”Ÿæˆå™¨ä¼šè¿è¡Œåˆ°ä¸‹ä¸€ä¸ªæš‚åœå¤„</span>
    <span class="token comment">// æ‹¿åˆ°yieldçš„è¿”å›å€¼èµ‹å€¼ç»™nextItem</span>
    <span class="token keyword">let</span> nextItem <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">handleResult</span><span class="token punctuation">(</span>nextItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token function">handleNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// å¦‚æœä¸æ·»åŠ ç¬¬45è¡Œä»£ç  å°±éœ€è¦æ·»åŠ å¦‚ä¸‹å‡ ç§æ–¹æ¡ˆå»è¿›è¡Œpromiseæ ‡å‡†åŒ–</span>
  <span class="token comment">//  return Promise.resolve(handleNext())</span>
  <span class="token comment">//  return Promise.resolve().then(handleNext)</span>
  <span class="token comment">//  return new Promise(res =&gt; {</span>
  <span class="token comment">//      res()</span>
  <span class="token comment">//  }).then(handleNext)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> res1 <span class="token operator">=</span> <span class="token keyword">yield</span> Promise<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>calc<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç¬¬ä¸€æ¬¡å¯åŠ¨ç”Ÿæˆå™¨ä¼šè¿è¡Œyieldåçš„è¡¨è¾¾å¼å¹¶æ‹¿åˆ°è¿”å›ç»“æœ</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;res1: &quot;</span><span class="token punctuation">,</span> res1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// åŒæ­¥è·å–</span>
    <span class="token keyword">let</span> res2 <span class="token operator">=</span> <span class="token keyword">yield</span> Promise<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>calc<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;res2: &quot;</span><span class="token punctuation">,</span> res2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//  æµ‹è¯•æŠ›å‡ºå¼‚å¸¸åæ˜¯å¦ç»§ç»­æ‰§è¡Œ</span>
  <span class="token keyword">let</span> res3 <span class="token operator">=</span> <span class="token keyword">yield</span> Promise<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>calc<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;res3: &quot;</span><span class="token punctuation">,</span> res3<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token string">&quot;the end&quot;</span><span class="token punctuation">;</span> <span class="token comment">// è¿™ä¸ªå€¼å°†åœ¨ç”Ÿæˆå™¨ä¸­æ‰€æœ‰å†…å®¹æ‰§è¡Œç»“æŸä¹‹åä¼ ç»™ run(gen).then(res=&gt; çš„res)</span>
<span class="token punctuation">}</span>

<span class="token function">run</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// generator runner çš„æµ“ç¼©å†™æ³•</span>
<span class="token keyword">function</span> <span class="token function">_run</span><span class="token punctuation">(</span><span class="token parameter">gen</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> it <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">handleNext</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> next <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">handleResult</span><span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> next<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>handleNext<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">handleErr</span><span class="token punctuation">(</span>
          <span class="token parameter">err</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>handleResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="es7-ä¹‹-async-await-ä¼ è¯´ä¸­çš„å¼‚æ­¥ç»ˆæè§£å†³æ–¹æ¡ˆ-babel-å·²ç»æ”¯æŒ"><a href="#es7-ä¹‹-async-await-ä¼ è¯´ä¸­çš„å¼‚æ­¥ç»ˆæè§£å†³æ–¹æ¡ˆ-babel-å·²ç»æ”¯æŒ" class="header-anchor">#</a> ES7 ä¹‹ async + await -- ä¼ è¯´ä¸­çš„å¼‚æ­¥ç»ˆæè§£å†³æ–¹æ¡ˆ ï¼ˆbabel å·²ç»æ”¯æŒï¼‰</h2> <p>å¼‚æ­¥ç¼–ç¨‹çš„æœ€é«˜å¢ƒç•Œï¼Œå°±æ˜¯æ ¹æœ¬ä¸ç”¨å…³å¿ƒå®ƒæ˜¯ä¸æ˜¯å¼‚æ­¥ã€‚ - é˜®ä¸€å³°</p> <ul><li>async å‡½æ•°å°±æ˜¯ç”Ÿæˆå™¨çš„è¯­æ³•ç³–ã€‚async å‡½æ•°å°±æ˜¯å°†ç”Ÿæˆå™¨å‡½æ•°çš„ï¼ˆ*ï¼‰æ›¿æ¢æˆ asyncï¼Œå°† yield æ›¿æ¢æˆ awaitã€‚<strong>è€Œä¸éœ€è¦å€ŸåŠ© generator runner è¾…åŠ©æ‰§è¡Œå™¨</strong></li></ul> <p>å…³é”®å­—è§£æï¼š</p> <ul><li><p>async å£°æ˜ä¸€ä¸ªæ–¹æ³•å†…éƒ¨æ˜¯å¼‚æ­¥çš„</p> <blockquote><p>async å‡½æ•°ï¼ˆåŒ…å«å‡½æ•°è¯­å¥ã€å‡½æ•°è¡¨è¾¾å¼ã€Lambda è¡¨è¾¾å¼ï¼‰ä¼šè¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œå¦‚æœåœ¨å‡½æ•°ä¸­ return ä¸€ä¸ªé promiseï¼Œasync ä¼šæŠŠè¿™ä¸ªç›´æ¥é‡é€šè¿‡ Promise.resolve()è¿›è¡Œæ ‡å‡†åŒ–</p></blockquote></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">testAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">$data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">testAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Promise{'...'}</span>

<span class="token function">testAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Promiseå¯¹è±¡ï¼Œå°±å¯ä»¥é€šè¿‡thenæ¥è°ƒç”¨</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><p>await ç­‰å¾…å¼‚æ­¥æ­¥éª¤ï¼Œ<strong>await åªèƒ½å‡ºç°åœ¨ async å†…éƒ¨</strong>ã€‚(async æ–¹æ³•å†…éƒ¨çš„å¼‚æ­¥æ“ä½œï¼‰</p> <blockquote><p>ç­‰å¾…ä¸€ä¸ªè¡¨è¾¾å¼çš„å€¼ï¼Œç­‰å¾…ä¸€ä¸ª promise çš„å†³è®®å€¼æˆ–è€…æ˜¯å…¶ä»–å€¼ï¼Œawait æ˜¯ä¸ªè¿ç®—ç¬¦ï¼Œç”¨äºç»„æˆè¡¨è¾¾å¼ï¼Œawait è¡¨è¾¾å¼çš„è¿ç®—ç»“æœå–å†³äºå®ƒç­‰çš„ä¸œè¥¿ã€‚å¦‚æœå®ƒç­‰åˆ°çš„ä¸æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ï¼Œé‚£ await è¡¨è¾¾å¼çš„è¿ç®—ç»“æœå°±æ˜¯å®ƒç­‰åˆ°çš„ä¸œè¥¿ã€‚å¦‚æœå®ƒç­‰åˆ°çš„æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ï¼Œawait å°±å¿™èµ·æ¥äº†ï¼Œå®ƒä¼šé˜»å¡åé¢çš„ä»£ç ï¼Œç­‰ç€ Promise å¯¹è±¡ resolveï¼Œç„¶åå¾—åˆ° resolve çš„å€¼ï¼Œä½œä¸º await è¡¨è¾¾å¼çš„è¿ç®—ç»“æœã€‚</p></blockquote></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;i rejected&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// ç­‰å¾…ä¸€ä¸ªè¡¨è¾¾å¼</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;i rejected&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç­‰å¾…ä¸€ä¸ªPromiseçš„å†³è®®å€¼</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// ç­‰å¾…ä¸€ä¸ªæ™®é€šå€¼</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> a <span class="token operator">=</span>
    <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span>
    <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">res</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 101</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">res</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span> <span class="token comment">// ä¹Ÿå¯ä»¥ç­‰å¾…ä¸¤ä¸ªå€¼åˆ†åˆ«ç»“æŸ</span>
<span class="token punctuation">}</span>

<span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 101</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><p>å’Œè¾…åŠ©å‡½æ•° generator runner ç›¸åŒçš„åŒæ­¥é”™è¯¯æ•è·</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">getDataWithTime</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">,</span> rej</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&lt;=</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">res</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">rej</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;too long&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> data1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getDataWithTime</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> data2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getDataWithTime</span><span class="token punctuation">(</span><span class="token number">600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> data3 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getDataWithTime</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> data1 <span class="token operator">+</span> data2 <span class="token operator">+</span> data3<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æˆ‘åˆcatchåˆ°äº†</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// too long</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ul> <h2 id="ç›¸å¯¹äº-promise-æœ‰ä»€ä¹ˆä¼˜åŠ¿"><a href="#ç›¸å¯¹äº-promise-æœ‰ä»€ä¹ˆä¼˜åŠ¿" class="header-anchor">#</a> ç›¸å¯¹äº promise æœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ</h2> <blockquote><p>å†™å¼‚æ­¥ä»£ç å°±åƒå†å†™åŒæ­¥ä»£ç ä¸€æ ·è½»æ¾æ— è´Ÿæ‹…ï¼Œå…·ä½“å¥½å¤„å¦‚ä¸‹ï¼š</p> <ol><li>ä¹¦å†™ä¹ æƒ¯å‡ ä¹è·ŸåŒæ­¥ä»£ç ä¸€æ ·</li> <li>async çš„å˜é‡æ˜¯åœ¨åŒä¸€ä¸ªä½œç”¨åŸŸä¸­ï¼Œè€Œ promise ä¿å­˜ä¸Šæ¬¡ç»“æœçš„æ—¶å€™éœ€è¦å€ŸåŠ©æ•°ç»„æˆ–è€…æ˜¯å¯¹è±¡æ¥ä¿å­˜</li></ol></blockquote> <ul><li><p>async await çš„å†™æ³•</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">getDataWithTime</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">res</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> data1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getDataWithTime</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> data2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getDataWithTime</span><span class="token punctuation">(</span><span class="token number">600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> data3 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getDataWithTime</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> data1 <span class="token operator">+</span> data2 <span class="token operator">+</span> data3<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//1500</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>promise å†™æ³•</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">getDataWithTime</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">res</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">res</span><span class="token punctuation">(</span><span class="token function">getDataWithTime</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">getDataWithTime</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">600</span><span class="token punctuation">,</span> data<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">getDataWithTime</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token operator">...</span>data<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">pre<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> pre <span class="token operator">+</span> next<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/frontend/javascript/regex.html">
        æ­£åˆ™è¡¨è¾¾å¼
      </a>
      â†’
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d0f45259.js" defer></script><script src="/assets/js/2.9e697bc4.js" defer></script><script src="/assets/js/32.78085356.js" defer></script>
  </body>
</html>
