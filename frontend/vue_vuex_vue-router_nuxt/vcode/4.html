<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title> Best Programming Language ï¼Ÿ ğŸ˜ˆ JAVASCRIPT</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Just learn and run">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.d0f45259.js" as="script"><link rel="preload" href="/assets/js/2.9e697bc4.js" as="script"><link rel="preload" href="/assets/js/46.cede0b20.js" as="script"><link rel="prefetch" href="/assets/js/10.48b8c953.js"><link rel="prefetch" href="/assets/js/11.f612be11.js"><link rel="prefetch" href="/assets/js/12.b835a644.js"><link rel="prefetch" href="/assets/js/13.be4ff992.js"><link rel="prefetch" href="/assets/js/14.bbd05573.js"><link rel="prefetch" href="/assets/js/15.1b4ee2f2.js"><link rel="prefetch" href="/assets/js/16.588a1728.js"><link rel="prefetch" href="/assets/js/17.ae68adab.js"><link rel="prefetch" href="/assets/js/18.68e9d6df.js"><link rel="prefetch" href="/assets/js/19.d2991acb.js"><link rel="prefetch" href="/assets/js/20.8fe6b2cd.js"><link rel="prefetch" href="/assets/js/21.12c5dbb4.js"><link rel="prefetch" href="/assets/js/22.ddd0487c.js"><link rel="prefetch" href="/assets/js/23.4cead595.js"><link rel="prefetch" href="/assets/js/24.0a65f294.js"><link rel="prefetch" href="/assets/js/25.0c8ed6b4.js"><link rel="prefetch" href="/assets/js/26.6591a69e.js"><link rel="prefetch" href="/assets/js/27.ff0fa1ef.js"><link rel="prefetch" href="/assets/js/28.858f8826.js"><link rel="prefetch" href="/assets/js/29.3f6b44e9.js"><link rel="prefetch" href="/assets/js/3.0b8b26d0.js"><link rel="prefetch" href="/assets/js/30.69cef0d1.js"><link rel="prefetch" href="/assets/js/31.576782ee.js"><link rel="prefetch" href="/assets/js/32.78085356.js"><link rel="prefetch" href="/assets/js/33.25cb7d39.js"><link rel="prefetch" href="/assets/js/34.d18511e2.js"><link rel="prefetch" href="/assets/js/35.6dc2bd90.js"><link rel="prefetch" href="/assets/js/36.b695c924.js"><link rel="prefetch" href="/assets/js/37.d803bac1.js"><link rel="prefetch" href="/assets/js/38.8abd0adb.js"><link rel="prefetch" href="/assets/js/39.3b23f090.js"><link rel="prefetch" href="/assets/js/4.e7c996f5.js"><link rel="prefetch" href="/assets/js/40.31a5553f.js"><link rel="prefetch" href="/assets/js/41.96f2dfc6.js"><link rel="prefetch" href="/assets/js/42.da2b78c0.js"><link rel="prefetch" href="/assets/js/43.2b80b114.js"><link rel="prefetch" href="/assets/js/44.03f54269.js"><link rel="prefetch" href="/assets/js/45.182bfe6b.js"><link rel="prefetch" href="/assets/js/47.869f0654.js"><link rel="prefetch" href="/assets/js/48.b8a8b538.js"><link rel="prefetch" href="/assets/js/49.d919b506.js"><link rel="prefetch" href="/assets/js/5.6eff8140.js"><link rel="prefetch" href="/assets/js/50.b754644d.js"><link rel="prefetch" href="/assets/js/51.a3cf1047.js"><link rel="prefetch" href="/assets/js/52.4ee6e441.js"><link rel="prefetch" href="/assets/js/6.17d5dd20.js"><link rel="prefetch" href="/assets/js/7.576da1bf.js"><link rel="prefetch" href="/assets/js/8.6fffe5ac.js"><link rel="prefetch" href="/assets/js/9.0041b96e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name"> Best Programming Language ï¼Ÿ ğŸ˜ˆ JAVASCRIPT</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>frontend</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>javascript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>css</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>browser</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>typescript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>nodejs</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>vuejs</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/frontend/vue_vuex_vue-router_nuxt/vcode/1.html" class="sidebar-link">new vue()ä¹‹å‰éƒ½å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿï¼ˆä¸€ï¼‰</a></li><li><a href="/frontend/vue_vuex_vue-router_nuxt/vcode/2.html" class="sidebar-link">new Vue(options) ä¸­çš„optionsåˆå¹¶å¤„ç†ï¼ˆäºŒï¼‰</a></li><li><a href="/frontend/vue_vuex_vue-router_nuxt/vcode/3.html" class="sidebar-link">åœ¨new Vue(options)ä¸­æ˜¯å¦‚ä½•ä¸ºoptionsè¿›è¡Œåˆå§‹åŒ–ï¼ˆä¸‰ï¼‰</a></li><li><a href="/frontend/vue_vuex_vue-router_nuxt/vcode/4.html" aria-current="page" class="active sidebar-link">initStateä¸å“åº”å¼åŸç†ï¼ˆå››ï¼‰</a></li><li><a href="/frontend/vue_vuex_vue-router_nuxt/vcode/5.html" class="sidebar-link">ä»$mountåˆ°è™šæ‹Ÿdomï¼ˆäº”ï¼‰</a></li><li><a href="/frontend/vue_vuex_vue-router_nuxt/vcode/diff.html" class="sidebar-link">diff æºç  æ³¨é‡Šç‰ˆ</a></li></ul></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><blockquote><p>vue çš„å“åº”å¼åŸç†åˆ†æï¼Œå¦‚æœå¯¹äºç»†èŠ‚éƒ¨åˆ†å‰–æçš„ä¸å¤Ÿæ¸…æ™°ä¸¢å¤±ç»†èŠ‚ï¼Œå°±ä¼šåœ¨é˜…è¯»ä»£ç çš„æ—¶å€™ä¸€çŸ¥åŠè§£ã€‚æœ¬ç« å°†ä»æ„æˆå“åº”å¼çš„æ¯ä¸ªéƒ¨åˆ†å¼€å§‹å…¨é¢åˆ†æå…¶åŸç†ã€‚æ‰¿æ¥ä¸Šä¸€ç« èŠ‚ï¼ŒinitState çš„æ ¸å¿ƒå°±æ˜¯å°±æ˜¯æ³¨å†Œå“åº”å¼ã€‚
æœ¬ç« å°†ä¼šæ¶‰åŠåˆ°ä»¥ä¸‹å“åº”å¼ç›¸å…³çš„æ¦‚å¿µã€‚</p></blockquote> <blockquote><p>âš ï¸ï¼šä¸ºäº†èƒ½è¯»æ‡‚æœ¬ç« èŠ‚å†…å®¹ï¼Œé¦–å…ˆæ˜ç¡®ä¸€ä¸ªæ¦‚å¿µã€‚å¯¹äº propsï¼Œdataï¼Œcomputed ä¸­çš„å±æ€§éƒ½æ˜¯å“åº”å¼çš„ï¼Œvue å†…éƒ¨èµ‹äºˆè¿™äº›å±æ€§ä¸€ç§é­”åŠ›ï¼Œå“ªé‡Œç”¨åˆ°è¿™äº›å±æ€§ï¼Œè¿™ä¸ªå±æ€§å°±ä¼šæ‹¿ä¸ªè®°å½•æœ¬â€œè®°ä½â€å½“å‰æ‰€åœ¨çš„ç¯å¢ƒï¼Œåœ¨è¿™ä¸ªå±æ€§å˜åŒ–çš„æ—¶å€™å°±ç¿»å¼€è®°å½•æœ¬å»ä¾æ¬¡é€šçŸ¥è®°å½•çš„æ¯ä¸ªç¯å¢ƒï¼Œç„¶åç¯å¢ƒå»å‘ŠçŸ¥ç¯å¢ƒä¸­æ‰€æœ‰çš„å†…å®¹å»æ£€æŸ¥æ›´æ–°ã€‚å…¶ä¸­è®°å½•æœ¬å°±æ˜¯â€œDepâ€ï¼Œè€Œç¯å¢ƒå°±æ˜¯â€œWatcherâ€ã€‚æ‘˜å–çš„æºç çœç•¥äº†éƒ¨åˆ† SSR çš„ç›¸å…³é€»è¾‘ã€‚</p></blockquote> <ol><li>Dep</li> <li>Wathcer
<ul><li>render-wathcer</li> <li>computed-wathcer</li> <li>user-wathcer</li></ul></li> <li>Obeserver</li> <li>defineReactive</li> <li>observe</li> <li>initState</li></ol> <h4 id="dep"><a href="#dep" class="header-anchor">#</a> Dep</h4> <h5 id="dep-æ„é€ å™¨"><a href="#dep-æ„é€ å™¨" class="header-anchor">#</a> Dep æ„é€ å™¨</h5> <p>ä¾èµ–æ”¶é›†å™¨ï¼Œæ”¶é›†è®¢é˜…è€…ã€‚æ¯ä¸ªå“åº”å¼çš„å±æ€§éƒ½åŒ…å«ä¸€ä¸ª depï¼ˆè®°å½•æœ¬ï¼‰ï¼Œç”¨äºæ”¶é›†ä½¿ç”¨äº†å½“å‰å±æ€§çš„è®¢é˜…è€…ï¼Œè®¢é˜…è€…æœ¬è´¨ä¸Šå°±æ˜¯ wathcerã€‚</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> uid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token function-variable function">Dep</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> uid<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>id æ¯ä¸ª dep éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ idï¼Œå”¯ä¸€æ ‡è¯†å½“å‰ depã€‚</li> <li>subs è®¢é˜…è€…ï¼Œwathcer æ•°ç»„ã€‚</li></ul> <h5 id="dep-å®ä¾‹æ–¹æ³•"><a href="#dep-å®ä¾‹æ–¹æ³•" class="header-anchor">#</a> Dep å®ä¾‹æ–¹æ³•</h5> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">Dep</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">addSub</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">addSub</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token class-name">Dep</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">removeSub</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">removeSub</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">,</span> sub<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>addSub æ·»åŠ è®¢é˜…è€…ã€‚</li> <li>removeSub å½“æŸä¸ªè°ƒç”¨å½“å‰å±æ€§çš„åœ°æ–¹ä¸åœ¨è°ƒç”¨äº†ï¼Œå°±ä»è®¢é˜…è€…åˆ—è¡¨ä¸­æ¸…é™¤è¿™ä¸ªè®¢é˜…è€…ã€‚</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">Dep</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">depend</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Dep<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">addDep</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token class-name">Dep</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">notify</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> subs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> subs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    subs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>depend æ”¶é›†è®¢é˜…è€…ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯è°ƒç”¨ addSubï¼Œåªä¸è¿‡åœ¨è°ƒç”¨ä¹‹å‰æ£€æŸ¥å½“å‰çš„ä¾èµ–æ˜¯ä¸æ˜¯å·²ç»æ”¶é›†è¿‡äº†ï¼Œè·³è¿‡å·²ç»æ”¶é›†è¿‡çš„ä¾èµ–ã€‚</li> <li>notify æ›´æ–°è®¢é˜…è€…ï¼Œé€šçŸ¥è®¢é˜…è€…æ•°æ®å·²ç»å‘ç”Ÿå˜åŒ–äº†ï¼Œéœ€è¦æ¯ä¸ªè®¢é˜…è€…å»è§¦å‘è‡ªå·±çš„å›è°ƒï¼ˆå¯èƒ½æ˜¯æ›´æ–°è§†å›¾ä¹Ÿå¯èƒ½æ˜¯è§¦å‘ç”¨æˆ·è®¾ç½®çš„å›è°ƒï¼‰ã€‚</li></ul> <h5 id="dep-é™æ€å±æ€§å’Œå…¨å±€æ–¹æ³•"><a href="#dep-é™æ€å±æ€§å’Œå…¨å±€æ–¹æ³•" class="header-anchor">#</a> Dep é™æ€å±æ€§å’Œå…¨å±€æ–¹æ³•</h5> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> targetStack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">pushTarget</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  targetStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> target<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">popTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  targetStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> targetStack<span class="token punctuation">[</span>targetStack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>Dep.target å½“å‰æ­£åœ¨æ‰§è¡Œæ›´æ–°(æˆ–è€…åˆå§‹åŒ–)çš„ wathcerã€‚</li> <li>targetStack ç»´æŠ¤ä¸€ä¸ª wathcer çš„æ ˆç»“æ„ï¼Œå› ä¸ºåœ¨æ›´æ–°ä¸€ä¸ª watcher çš„æ—¶å€™ä¹Ÿå¯èƒ½ä¼šè¿›å…¥å…¶ä»–çš„ watcher çš„å†…éƒ¨ï¼Œæ­¤æ—¶å°±éœ€è¦ä¿å­˜ä¸Šä¸€ä¸ª watcherï¼Œä¸ºäº†å›æº¯çš„æ—¶å€™ä¸ä¸¢å¤±ä¸Šä¸ª watcherã€‚</li> <li>push/popTarget æ“ä½œè¿™ä¸ªæ ˆç»“æ„ï¼Œpush å‹æ ˆï¼Œpop å¼¹æ ˆï¼ŒDep.target å§‹ç»ˆæŒ‡å‘æ ˆé¡¶å…ƒç´ ã€‚</li></ul> <h4 id="watcher"><a href="#watcher" class="header-anchor">#</a> Watcher</h4> <h5 id="render-wathcer"><a href="#render-wathcer" class="header-anchor">#</a> render-wathcer</h5> <p>å½“æ‰§è¡Œåˆ›å»ºç»„ä»¶çš„æ–¹æ³•ï¼Œå°±ä¼šä¸ºæ¯ä¸ªç»„ä»¶ vm åˆ›å»ºä¸€ä¸ª wathcerï¼ŒæŸ¥çœ‹ vue é€šè¿‡å¦‚ä¸‹ä»£ç è¿›è¡Œ render-watcher çš„åˆ›å»ºã€‚</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>
  vm<span class="token punctuation">,</span> <span class="token comment">// watcher.vm</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// watcher.getter</span>
    vm<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">_render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  noop<span class="token punctuation">,</span> <span class="token comment">// watcher.cb</span>
  <span class="token punctuation">{</span>
    <span class="token comment">// watcher.before</span>
    <span class="token function-variable function">before</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_isMounted <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>vm<span class="token punctuation">.</span>_isDestroyed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">&quot;beforeUpdate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token boolean">true</span> <span class="token comment">/* isRenderWatcher */</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>éœ€è¦æ³¨æ„çš„æ˜¯ render-wathcer æ˜¯æŠŠå½“å‰ vm çš„_render å’Œ_update æ–¹æ³•ä¼ å…¥ç„¶åç­‰å¾…æ‰§è¡Œï¼Œå¯¹äº render-watcher æ¥è¯´ï¼Œæ›´æ–°è§†å›¾å°±æ˜¯å®ƒçš„ getter çš„ä»»åŠ¡ï¼Œåˆ†è§£æ¥è¯´å°±æ˜¯ï¼š</p> <ul><li>åœ¨æŒ‚è½½ç»„ä»¶çš„æ—¶å€™ä¼šåˆå§‹åŒ–å½“å‰ vm å¯¹åº”çš„ render-watcher</li> <li>getter ä¼šåœ¨ watcher åˆå§‹åŒ–çš„æ—¶å€™æ‰§è¡Œï¼Œå°±ä¼šæ‰§è¡Œ render ç”Ÿæˆ vnode å¹¶ update ç”ŸæˆçœŸå® domï¼Œ</li> <li>å› ä¸ºæ¸²æŸ“è¿‡ç¨‹ä¸­å¿…ç„¶ä¼šç”¨åˆ° propï¼Œcomputedï¼Œdata ä¸­çš„å±æ€§ï¼Œè¿™æ ·å°±åœ¨æ¸²æŸ“çš„åŒæ—¶è¿›è¡Œä¾èµ–æ”¶é›†ã€‚</li></ul> <h5 id="computed-wathcer"><a href="#computed-wathcer" class="header-anchor">#</a> computed-wathcer</h5> <p>ç”¨æˆ·ä¼ å…¥çš„ computed è®¡ç®—å±æ€§æœ¬è´¨ä¸Šä¹Ÿæ˜¯ watcherï¼Œå’Œ watch å±æ€§ä¸åŒçš„æ˜¯ï¼Œè®¡ç®—å±æ€§çš„ watch æ˜¯ lazy çš„ã€‚å¦‚ä¸‹ï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>
  vm<span class="token punctuation">,</span> <span class="token comment">// watcher.vm å½“å‰è®¡ç®—å±æ€§æ‰€åœ¨çš„vm</span>
  getter <span class="token operator">||</span> noop<span class="token punctuation">,</span> <span class="token comment">// watcher.getter ç”¨æˆ·ä¼ å…¥çš„æ–¹æ³•</span>
  noop<span class="token punctuation">,</span> <span class="token comment">// watcher.cb</span>
  <span class="token punctuation">{</span> lazy<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token comment">// watcher.lazy</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>å’Œ render-watcher ç›¸åŒï¼Œè®¡ç®—å±æ€§çš„ getter å†…éƒ¨ä½¿ç”¨çš„å“åº”å¼å±æ€§çš„ dep ä¹Ÿä¼šè®°å½•å½“å‰ computed-wathcerï¼Œç”¨ä¼ å…¥çš„æ–¹æ³•å…¶å®å°±æ˜¯ getterã€‚å¦‚ä¸‹ï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>computed<span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token function">property</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>firstName <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastName
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ­¤æ—¶ firstName çš„ dep å’Œ lastName çš„ dep éƒ½å°†è®°å½•å½“å‰è®¡ç®—å±æ€§çš„ watcherï¼Œå¦å¤–è¿˜ä¼šè®°å½•å½“å‰è®¡ç®—å±æ€§æ‰€åœ¨çš„å…¶ä»– watcherï¼Œæ¯”å¦‚è®¡ç®—å±æ€§åœ¨ template æ¨¡ç‰ˆä¸­ä½¿ç”¨äº†ï¼Œåœ¨æ¸²æŸ“çš„æ—¶å€™ï¼Œå°±ä¼šè®°å½•ä¸‹ vm çš„ render-watcherï¼Œå¦‚æœå½“å‰è®¡ç®—å±æ€§åœ¨å…¶ä»–è®¡ç®—å±æ€§ä½¿ç”¨äº†ï¼Œå°±ä¼šè®°å½•å…¶ä»–è®¡ç®—å±æ€§çš„ watcherï¼Œç›¸å½“äºæ˜¯æŠŠè¿™äº› watcher çš„åµŒå¥—å…³ç³»è¿›è¡Œä¸€å±‚æ·±åº¦çš„æ‹å¹³ç„¶åæ·»åŠ åˆ°æ¯ä¸ª dep ä¸­å»ã€‚</p> <h5 id="user-watcher"><a href="#user-watcher" class="header-anchor">#</a> user-watcher</h5> <p>ç”¨æˆ·é€šè¿‡ watch ä¼ å…¥æˆ–è€…é€šè¿‡ this.$watch()ç”Ÿæˆçš„ watcherï¼Œvue å†…éƒ¨é€šè¿‡å¦‚ä¸‹æ–¹å¼åˆ›å»ºä¸€ä¸ª user-watcherã€‚</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> watcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>
  vm<span class="token punctuation">,</span> <span class="token comment">// watcher.vm</span>
  expOrFn<span class="token punctuation">,</span> <span class="token comment">// watcher.getter</span>
  cb<span class="token punctuation">,</span> <span class="token comment">// watcher.cb</span>
  Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> user<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> userOptions<span class="token punctuation">)</span> <span class="token comment">// watcher.user ä»¥åŠå…¶ä»–ç”¨æˆ·æƒ³è¦é…ç½®çš„å†…å®¹</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>å¯ä»¥å‘ç° user-watcher ä¸»è¦é…ç½®äº† user:true å±æ€§ï¼Œç„¶åç”¨æˆ·å¯ä»¥ä¼ å…¥ä¸€äº›é…ç½®å»æ§åˆ¶è¿™ä¸ª watcherã€‚</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$watch</span><span class="token punctuation">(</span>
  <span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//do something å½“ vm['a'] çš„å€¼å˜åŒ–</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> deep<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>è¿™ä¸ªä¾‹å­ä¸­'a'å°†ä¼šè½¬åŒ–ä¸º user-watcher çš„ getterã€‚å®é™…ä¸Šå°±æ˜¯å¯¹ vm['a']è¿›è¡Œä¸€æ¬¡å‡½æ•°å°è£…,å½“ç„¶è¿™æ˜¯ä¸ªå“åº”å¼çš„å€¼ï¼Œåœ¨åˆå§‹åŒ–è¿™ä¸ª watcher çš„æ—¶å€™å°±ä¼šç”¨åˆ° getterï¼Œè¿›è€Œå‡ºå‘åˆ° vm['a']ï¼Œè¿™ä¸ªå“åº”å¼çš„å€¼çš„ dep å°±ä¼šæ”¶é›†åˆ°å½“å‰ user-watcherï¼Œä¹Ÿå°±å¯ä»¥åœ¨ vm['a']å˜åŒ–çš„æ—¶å€™å»é€šçŸ¥åˆ° user-watcher ä¹Ÿèƒ½å»è°ƒç”¨ç”¨æˆ·ä¼ å…¥çš„å›è°ƒã€‚</p> <h5 id="watcher-æ„é€ å™¨"><a href="#watcher-æ„é€ å™¨" class="header-anchor">#</a> Watcher æ„é€ å™¨</h5> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> uid$<span class="token number">2</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token function-variable function">Watcher</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">Watcher</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span>expOrFn<span class="token punctuation">,</span>cb<span class="token punctuation">,</span>options<span class="token punctuation">,</span> isRenderWatcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>vm <span class="token operator">=</span> vm<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isRenderWatcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span>_watcher <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  vm<span class="token punctuation">.</span>_watchers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token operator">++</span>uid$<span class="token number">2</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>å…¥å‚
<ul><li>vm å½“å‰ watcher å¯¹åº”çš„ç»„ä»¶å®ä¾‹</li> <li>expOrFn æ¯æ¬¡å“åº”å¼æ•°æ®å˜åŒ–éƒ½å°†è§¦å‘çš„æ–¹æ³•æˆ–è€…è¡¨è¾¾å¼æŒ‡å‘çš„æ–¹æ³•</li> <li>cb ç”¨æˆ·ä¼ å…¥çš„å›è°ƒæ–¹æ³•ï¼Œå½“ expOrFn æ‰§è¡Œå®Œæ¯•ä¹‹åå’Œä¸Šæ¬¡ä¿å­˜çš„å€¼åšæ¯”å¯¹ï¼Œå¦‚æœå˜åŒ–äº†å°±ä¼šè§¦å‘å›è°ƒã€‚</li> <li>options âš ï¸ è¿™ä¸ª options ä¸æ˜¯ç»„ä»¶çš„ optionsï¼Œè€Œæ˜¯å½“å‰ watcher çš„ optons</li> <li>isRenderWatcher æ ‡è¯†å½“å‰æ˜¯ä¸æ˜¯ç»„ä»¶çš„æ¸²æŸ“ watcher</li></ul></li> <li>id æ¯ä¸€ä¸ª watcher éƒ½æœ‰å”¯ä¸€çš„ idï¼Œè¿™ä¸ª id åœ¨æ¸²æŸ“çš„æ—¶å€™ä¼šè¢«ç”¨äºæ’åºï¼ˆè¿™ç‚¹åœ¨ nextTick ç« èŠ‚è¿›è¡Œè¯¦ç»†è§£è¯»ï¼‰ã€‚</li> <li>vm._watcher å¦‚æœä¼ å…¥äº†æ ‡è¯†ï¼Œå°±æŠŠå½“å‰ watcher ä½œä¸ºå½“å‰ vm çš„æ¸²æŸ“ watcher è¿›è¡Œèµ‹å€¼ã€‚</li> <li>vm._watchers æ— è®ºæ˜¯æ¸²æŸ“ watcher è¿˜æ˜¯å…¶ä»– watcherï¼Œéƒ½ä¼šä¿å­˜åˆ°å½“å‰ vm çš„ _watchers æ•°ç»„ä¸­ã€‚</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>deep <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>deep<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>user<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>lazy<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>sync <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>sync<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>before <span class="token operator">=</span> options<span class="token punctuation">.</span>before<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>deep <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sync <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">=</span> cb<span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy<span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>newDeps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>depIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>expression <span class="token operator">=</span>
  process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">?</span> expOrFn<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>deep å½“å‰æ˜¯ä¸æ˜¯æ·±åº¦ç›‘å¬çš„ï¼Œç”¨æˆ·æ‰‹åŠ¨è®¾ç½®åä¸º true</li> <li>user æ ‡è¯†ç”¨æˆ·è®¾ç½®çš„ watcher</li> <li>lazy æ ‡å¿—å½“å‰ watcher æ˜¯ä¸æ˜¯ lazy çš„ï¼ˆç”¨åˆ°çš„æ—¶å€™æ‰è®¡ç®—å€¼ï¼‰ã€‚</li> <li>sync è¿‘å¼€å‘æ¨¡å¼ä¸‹å¯è®¾ç½®ï¼Œè®¾ç½® true å watcher çš„æ›´æ–°å°†åœ¨æœ¬æ¬¡æ—¶é—´å¾ªç¯è€Œä¸å»æ·»åŠ åˆ° nextTick æ‰§è¡Œã€‚</li> <li>before åœ¨æ‰§è¡Œ watcher æ›´æ–°ä¹‹å‰éœ€è¦æ‰§è¡Œçš„æ–¹æ³•ï¼ˆåœ¨ render-watcher çš„ case ä¸‹ï¼Œæ‰§è¡Œçš„æ˜¯ beforeUpdate é’©å­ï¼‰</li> <li>cb åœ¨æ‰§è¡Œ watcher æ›´æ–°ä¹‹åéœ€è¦æ‰§è¡Œçš„å›è°ƒï¼Œä¼šä¼ å…¥æ–°å€¼å’Œæ—§å€¼ï¼Œç”¨äºç”¨æˆ·è‡ªå®šä¹‰çš„ watcherã€‚</li> <li>active æ ‡è¯†å½“å‰ watcher æ˜¯ä¸æ˜¯æ´»è·ƒçš„ã€‚åœ¨ watcher è¢«å…³é—­åä¸º false</li> <li>dirty æ ‡è¯†å½“å‰ watcher çš„å€¼æœ‰æ²¡æœ‰å˜åŒ–ï¼Œä½œä¸º lazy åŒ–çš„ watcher çš„è®¡ç®—æ ‡è¯†ã€‚</li> <li>deps è¢«å½“å‰ watcher è®¢é˜…çš„ depï¼ˆä¹Ÿå°±æ˜¯ä¿å­˜äº†å½“å‰ watcher éƒ½ä½äºå“ªäº› dep.subs æ•°ç»„ä¸­ï¼‰</li> <li>newDeps wathcer æ¯æ¬¡è¿›è¡Œè®¢é˜…çš„ dep éƒ½å°†ä¿å­˜åˆ°è¿™ä¸ªæ•°ç»„ä¸­ï¼Œè¿™ä¸ªæ•°ç»„å°†ä¼šå’Œ deps è¿›è¡Œæ¯”è¾ƒï¼ˆå…¶å®å°±æ˜¯æ›´æ–° dep çš„è®¢é˜…è€…æ•°ç»„ï¼Œé˜²æ­¢åœ¨ç”¨æˆ·è¿›è¡Œä¾èµ–è§£é™¤ï¼ˆå¯èƒ½æ˜¯ teardownï¼‰ä¹‹åè¿˜è§¦å‘æ— ç”¨çš„æ›´æ–°ï¼‰</li> <li>depIds ä¿å­˜ deps ä¸­æ¯ä¸ª dep çš„ id</li> <li>newDepIds ä¿å­˜ newDeps ä¸­æ¯ä¸ª dep çš„ id</li> <li>expression åœ¨å¼€å‘ç¯å¢ƒä¸‹ä¿å­˜ç”¨æˆ·ä¼ å…¥çš„éœ€è¦ç›‘å¬è¡¨è¾¾å¼ï¼Œæ²¡æœ‰ä»€ä¹ˆå®é™…ç”¨å¤„ã€‚åªæ˜¯åœ¨è°ƒè¯•çš„æ—¶å€™çœ‹ä¸€çœ‹ã€‚</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> expOrFn <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> expOrFn<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> <span class="token function">parsePath</span><span class="token punctuation">(</span>expOrFn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>getter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> noop<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>getter æ ¹æ®ç”¨æˆ·ä¼ å…¥çš„è¡¨è¾¾å¼æˆ–è€…æ˜¯ function è®¡ç®—å‡ºéœ€è¦ç›‘å¬çš„æ•°æ®ã€‚å¦‚ä¸‹:</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 1</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$watch</span><span class="token punctuation">(</span>
  <span class="token string">&quot;a.b.c&quot;</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//do something å½“ vm['a']['b']['c'] çš„å€¼å˜åŒ–ä¹‹å</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> deep<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 2</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$watch</span><span class="token punctuation">(</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// do something å½“vm['a'] + vm['b']çš„å’Œå˜åŒ–ä¹‹å</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>value æ˜¯ getter æ‰§è¡Œä¹‹åçš„è¿”å›å€¼</li></ul> <h5 id="watcher-çš„å®ä¾‹æ–¹æ³•"><a href="#watcher-çš„å®ä¾‹æ–¹æ³•" class="header-anchor">#</a> Watcher çš„å®ä¾‹æ–¹æ³•</h5> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">Watcher</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">get</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">pushTarget</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> value<span class="token punctuation">;</span>
  <span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token string">'getter for watcher &quot;'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>expression <span class="token operator">+</span> <span class="token string">'&quot;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>deep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">traverse</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">popTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cleanupDeps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>new Wacther()æœ€ç»ˆä¼šè§¦å‘è¿™ä¸ª get æ–¹æ³•(é™¤äº† lazy æ¨¡å¼)</p> <ul><li>è®¾ç½®å½“å‰ä¾èµ–ç›®æ ‡ Dep.target ä¸ºå½“å‰ watcherï¼Œ å¯èƒ½æ˜¯ user-watcher computed-watcher render-wathcer ä¸‰è€…ä»»æ„ä¸€ä¸ªï¼Œè®¾ç½®å®Œä¹‹ååœ¨æ‰§è¡Œ getterï¼Œå°±ä¼šåœ¨ä¾èµ–æ”¶é›†çš„æ—¶å€™æ”¶é›†åˆ° Dep.target äº†ã€‚</li> <li>ç„¶åå»æ‰§è¡Œå½“å‰ wactcher å¯¹åº”çš„ getter å¹¶è¿”å›è®¡ç®—å€¼</li> <li>traverse è¿›è¡Œæ·±åº¦çš„ä¾èµ–æ”¶é›†</li> <li>cleanupDeps æ›´æ–° dep å’Œ depid æ•°ç»„</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">Watcher</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">addDep</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">addDep</span><span class="token punctuation">(</span><span class="token parameter">dep</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> id <span class="token operator">=</span> dep<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>depIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      dep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>addDep éå¸¸ç®€å•ï¼Œå°±æ˜¯æŠŠå½“å‰ wathcer æ·»åŠ åˆ° dep ä¸­å»ï¼Œåœ¨ Dep.prototype.depend è¿›è¡Œè°ƒç”¨ã€‚</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">Watcher</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">cleanupDeps</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">cleanupDeps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> dep <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>dep<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ–°ä¼ å…¥çš„ä¾èµ–é¡¹ä¸­æ²¡æœ‰å½“å‰id å°±åœ¨depä¸­åˆ é™¤å½“å‰wathcer  å°±ä»£è¡¨æ›´æ–°åçš„depä¸­ä¸éœ€è¦æ”¶é›†å½“å‰watcher</span>
      dep<span class="token punctuation">.</span><span class="token function">removeSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> tmp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>depIds<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>depIds <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ–°æ—§depidä¾èµ–äº¤æ¢ ç„¶åæŠŠæ–°çš„æ¸…ç©º ç­‰å¾…ä¸‹æ¬¡ä¾èµ–æ›´æ–°</span>

  tmp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// æ–°æ—§depäº¤æ¢</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>cleanupDeps å»ä¿è¯å½“å‰åªæ”¶é›†äº†å®é™…åº”ç”¨åˆ°çš„ depï¼Œé˜²æ­¢è§¦å‘æ— ç”¨çš„ watcher.update è€Œé€ æˆæ€§èƒ½æµªè´¹ã€‚</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">Watcher</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">update</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lazy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">queueWatcher</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>update æ–¹æ³•åªæ˜¯ä¸€ä¸ªç®€å•çš„è§¦å‘å™¨ï¼Œåˆ†åˆ«ä¸º lazy çš„ wathcer æ ‡è®° dirtyï¼Œåœ¨åŒæ­¥æ¨¡å¼ä¸‹ç›´æ¥è¿›è¡Œ run æ–¹æ³•è¿›è¡Œè§†å›¾æ›´æ–°æˆ–è€…æ•°æ®æ›´æ–°ï¼Œåœ¨å¼‚æ­¥æ¨¡å¼ä¸‹é€šè¿‡ nextTick åœ¨ä¸‹ä¸ªäº‹ä»¶å¾ªç¯å»è§¦å‘ run æ–¹æ³•ï¼Œå®é™…ä¸Š update æ–¹æ³•å°±æ˜¯å¯¹ run æ–¹æ³•çš„äºŒæ¬¡å°è£…ã€‚</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">Watcher</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">||</span> <span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> oldValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cb</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">,</span> value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">handleError</span><span class="token punctuation">(</span>
            e<span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">,</span>
            <span class="token string">'callback for watcher &quot;'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>expression <span class="token operator">+</span> <span class="token string">'&quot;'</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cb</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">,</span> value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>run æ–¹æ³•åšäº†ä¸¤ä»¶äº‹ï¼š</p> <ul><li>é€šè¿‡ get æ–¹æ³•å»è§¦å‘ wathcer.getter,é‡æ–°è®¡ç®—å€¼æˆ–è€…è§†å›¾æ›´æ–°ã€‚</li> <li>é€šè¿‡ cb ä¼ å…¥æ›´æ–°å‰çš„å€¼å’Œæ›´æ–°åçš„å€¼ä¾›ç”¨æˆ·ä¼ å…¥çš„æ–¹æ³•ä½¿ç”¨ã€‚</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">Watcher</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">evaluate</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>evaluate æ˜¯ä¸º lazy çš„ watcher æœåŠ¡çš„ï¼ˆå¤§å¤šæ˜¯ä¸ºäº† computed æœåŠ¡çš„ï¼‰ï¼Œåœ¨ç”¨åˆ°çš„ lazy çš„ wathcer å€¼çš„æ—¶å€™å°±é€šè¿‡è¿™ä¸ªæ–¹æ³•ä¸´æ—¶è®¡ç®—ä¸€ä¸‹å€¼ã€‚</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">Watcher</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">depend</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>depend æ˜¯éå†å½“å‰ watcher å†…éƒ¨æ‰€æœ‰çš„ dep å¯¹å½“å‰ Dep.target å…¨éƒ¨è¿›è¡Œä¸€æ¬¡ä¾èµ–æ”¶é›†ï¼Œä¸»è¦ä¹Ÿæ˜¯ä¸ºäº† computed æœåŠ¡çš„ã€‚</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">Watcher</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">teardown</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">teardown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">.</span>_isBeingDestroyed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">.</span>_watchers<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">removeSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>teardown å…³é—­å½“å‰ watcherï¼Œåœ¨æ‰€æœ‰ dep ä¸­æ¸…æ¥šè¯¥ watcherï¼ˆè§£é™¤è®¢é˜…ï¼‰ï¼Œactive æ ‡è¯†ä¸º falseï¼Œé˜²æ­¢å†æ¬¡è§¦å‘ updateã€‚</p> <h4 id="observer"><a href="#observer" class="header-anchor">#</a> Observer</h4> <p>Observer å…¶å®éå¸¸ç®€å•ï¼ŒåŠŸèƒ½åªæœ‰ä¸€ä¸ªï¼Œå°±æ˜¯ä¸ºå¯¹è±¡æˆ–è€…æ•°ç»„ç±»å‹çš„å€¼æ³¨å†Œå“åº”å¼ã€‚observe æ–¹æ³•å†…éƒ¨ä¹Ÿæ˜¯åœ¨è°ƒç”¨ new Observer()å¹¶è¿”å›è¿™ä¸ªå®ä¾‹ï¼Œè€Œ defineReactive å†…éƒ¨ä¹Ÿä¼šä¸ºå¯¹è±¡ç±»å‹çš„å±æ€§è¿›è¡Œ observe(value)è°ƒç”¨ï¼Œå®é™…ä¸Šä¹Ÿæ˜¯ä¸ºå¯¹è±¡å±æ€§åˆ›å»º Obseverã€‚æ— è®ºæ˜¯å¯¹è±¡è¿˜æ˜¯æ•°ç»„ï¼Œæ•´ä¸ªå“åº”å¼æ³¨å†Œè¿‡ç¨‹æ˜¯æ·±åº¦éå†çš„è¿‡ç¨‹ã€‚</p> <h5 id="observer-æ„é€ å™¨"><a href="#observer-æ„é€ å™¨" class="header-anchor">#</a> Observer æ„é€ å™¨</h5> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> <span class="token function-variable function">Observer</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">Observer</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>vmCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>dep å¯¹è±¡ç±»å‹çš„å€¼æ‹¥æœ‰ä¸¤ä¸ª depï¼Œä¸€ä¸ª dep æ˜¯åœ¨ defineReactive å†…éƒ¨é—­åŒ…å®šä¹‰ä¿å­˜çš„ depï¼Œè¿™ä¸ª dep å¯ä»¥åœ¨ç›´æ¥åˆ é™¤å½“å‰å¯¹è±¡æˆ–è€…ä¿®æ”¹å½“å‰å¯¹è±¡çš„æ—¶å€™è¾¾åˆ°å“åº”å¼ã€‚ä½†æ˜¯å¯¹äºæ²¡æœ‰åœ¨ data ä¸­è¿›è¡Œåˆå§‹åŒ–çš„å¯¹è±¡çš„å±æ€§ï¼Œå°±æ— æ³•è¾¾åˆ°å“åº”å¼æ“ä½œï¼Œäºæ˜¯å°±ä¸ºå¯¹è±¡å’Œæ•°ç»„ç±»å‹èƒ½å¤Ÿåœ¨æ·»åŠ å€¼çš„æ—¶å€™è¾¾åˆ°å“åº”å¼è€Œå†æ¬¡åˆ›å»ºä¸€ä¸ª depï¼Œï¼ˆè¿™ä¸ª dep æ˜¯åœ¨$setï¼Œ$delete æ–¹æ³•è¢«æ‰§è¡Œæ—¶è¿›è¡Œ notify æ“ä½œï¼Œè¿™é‡Œä»…éœ€æ˜ç™½æ˜¯ä¸ºäº†å¯¹è±¡å“åº”å¼åšæœåŠ¡å³å¯ï¼‰ã€‚</li> <li>value éœ€è¦æ³¨å†Œå“åº”å¼çš„å€¼</li> <li>vmCount è®°å½•å½“å‰ observer å®ä¾‹ç›¸å…³çš„ vm æ•°é‡</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token function">def</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">'__ob__'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hasProto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">protoAugment</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> arrayMethods<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">copyAugment</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> arrayMethods<span class="token punctuation">,</span> arrayKeys<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">observeArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><code>__ob__</code> å°±æ˜¯ä¸ºå½“å‰å¯¹è±¡ value æ·»åŠ  oberver å®ä¾‹ï¼Œé€šè¿‡ç±»å‹åˆ¤æ–­åˆ†åˆ«ä¸ºå¯¹è±¡å’Œæ•°æ®è¿›è¡Œä¸åŒçš„å“åº”å¼å¤„ç†ã€‚</p> <h5 id="observer-çš„å®ä¾‹æ–¹æ³•"><a href="#observer-çš„å®ä¾‹æ–¹æ³•" class="header-anchor">#</a> Observer çš„å®ä¾‹æ–¹æ³•</h5> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">Observer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">walk</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">walk</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">defineReactive$$1</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>walk æ–¹æ³•æ˜¯ä¸ºå¯¹è±¡ç±»å‹çš„å±æ€§æ³¨å†Œå“åº”å¼ï¼Œéå†å¯¹è±¡ä¸Šçš„æ¯ä¸ªå±æ€§ï¼Œè°ƒç”¨ defineReactive å»åˆ†åˆ«ä¸ºæ¯ä¸ªå±æ€§è¿›è¡Œæ³¨å†Œï¼Œå®Œæˆé€’å½’çš„å“åº”å¼æ³¨å†Œã€‚</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">Observer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">observeArray</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">observeArray</span><span class="token punctuation">(</span><span class="token parameter">items</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> items<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">observe</span><span class="token punctuation">(</span>items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>observeArray éå†æ•°ç»„ä¸­çš„æ¯ä¸ªæ•°æ®è¿›è¡Œå“åº”å¼æ³¨å†Œï¼Œéœ€è¦ä½œå‡ºåŒºåˆ«çš„æ˜¯ï¼Œç›´æ¥è°ƒç”¨ observe ä»…ä»…å¯¹å¯¹è±¡ç±»å‹çš„å±æ€§è¿›è¡Œæ·±å±‚çš„å“åº”å¼æ³¨å†Œï¼Œè€Œæ— éœ€å¯¹åŸºæœ¬ç±»å‹è¿›è¡Œ defineReactiveï¼Œå› ä¸ºæ•°æ®åœ¨åŸå‹é“¾ä¸Šæ·»åŠ äº†ä¸€å±‚æ‹¦æˆªï¼Œç”¨äºå¤„ç†åŸºç¡€ç±»å‹çš„å“åº”å¼å¤„ç†ã€‚</li></ul> <h4 id="definereactive-å®šä¹‰å“åº”å¼"><a href="#definereactive-å®šä¹‰å“åº”å¼" class="header-anchor">#</a> defineReactive - å®šä¹‰å“åº”å¼</h4> <p>vue å“åº”å¼ä¸­æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ã€‚è¿™ä¸ªæ–¹æ³•å°±æ˜¯èµ‹äºˆæ¯ä¸ªå±æ€§å“åº”å¼çš„é™„é­”å¸ˆã€‚</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span>key<span class="token punctuation">,</span>val<span class="token punctuation">,</span>customSetter<span class="token punctuation">,</span>shallow</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>å…¥å‚
<ul><li>obj éœ€è¦å®šä¹‰å“åº”å¼çš„å¯¹è±¡</li> <li>key éœ€è¦å®šä¹‰å“åº”å¼çš„å¯¹è±¡çš„å±æ€§å</li> <li>val éœ€è¦å®šä¹‰å“åº”å¼çš„å¯¹è±¡çš„å±æ€§åå¯¹åº”çš„åˆå€¼</li> <li>customSetter ä¸ªæ€§åŒ– setterï¼Œä¸»è¦ä¸ºäº†åœ¨ç”¨æˆ·è¯•å›¾å¤–éƒ¨ä¿®æ”¹æŸäº›å€¼çš„æ—¶å€™è¿›è¡Œæç¤ºï¼Œä¾‹å¦‚ prop å±æ€§ï¼Œinject å±æ€§ï¼Œæ˜¯ä¸æ¨èå¤–éƒ¨ä¿®æ”¹çš„ã€‚</li> <li>shallow æ˜¯ä¸æ˜¯æ³¨å†Œæµ…å±‚çš„å“åº”å¼ã€‚ä¾‹å¦‚$listenersï¼Œ$attrs éƒ½æ˜¯æ³¨å†Œäº†æµ…å±‚çš„å“åº”å¼ã€‚å› ä¸ºåœ¨æ›´æ–°ç»„ä»¶çš„æ—¶å€™æ˜¯ç›´æ¥æ›¿æ¢$attrså’Œ$listenersï¼Œæ— éœ€æ³¨å†Œæ·±å±‚çš„å“åº”å¼ã€‚</li></ul></li> <li>dep åˆå§‹åŒ–ä¸€ä¸ª depï¼Œå»æ”¶é›†è¯¥å±æ€§æ‰€æœ‰çš„è®¢é˜…è€…ï¼Œæ¯ä¸ªå±æ€§éƒ½é€šè¿‡é—­åŒ…æŒæœ‰ä¸€ä¸ª depã€‚</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> property <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>property <span class="token operator">&amp;&amp;</span> property<span class="token punctuation">.</span>configurable <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> getter <span class="token operator">=</span> property <span class="token operator">&amp;&amp;</span> property<span class="token punctuation">.</span>get<span class="token punctuation">;</span>
<span class="token keyword">var</span> setter <span class="token operator">=</span> property <span class="token operator">&amp;&amp;</span> property<span class="token punctuation">.</span>set<span class="token punctuation">;</span>
<span class="token keyword">var</span> childOb <span class="token operator">=</span> <span class="token operator">!</span>shallow <span class="token operator">&amp;&amp;</span> <span class="token function">observe</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>property å½“å‰ key å¯¹åº”çš„å±æ€§æè¿°å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡åŒ…å«äº† obj[key]çš„å¯æšä¸¾æ€§ï¼Œå¯é…ç½®æ€§ï¼Œä»¥åŠ getterï¼Œsetterï¼Œé€šè¿‡è¯¥å¯¹è±¡æŸ¥çœ‹å½“å‰å±æ€§æ˜¯ä¸æ˜¯å¯é…ç½®çš„ï¼Œå¦‚æœ false ç›´æ¥ return</li> <li>getter è°ƒç”¨ getter å¯ä»¥è·å–è¿™ä¸ª obj[key]çš„å€¼</li> <li>setter è°ƒç”¨ setter(newVal)å¯ä»¥è®¾ç½® obj[key]ä¸º newVal</li> <li>childOb å¯ä»¥å‘ç° defineReactive è°ƒç”¨äº† observe(val)è¿›è¡Œæ·±å±‚çš„å“åº”å¼æ³¨å†Œã€‚ è€Œ observe åªä¼šå¯¹å¯¹è±¡ç±»å‹çš„å±æ€§è¿›è¡Œå“åº”å¼æ³¨å†Œï¼ˆä¸‹é¢æœ‰ observe æ–¹æ³•çš„åˆ†æï¼‰ï¼Œåœ¨ä¸Šè¾¹ Obsever æ„é€ å™¨çš„åˆ†æä¸­ï¼Œ<code>def(value, '__ob__', this);</code>ï¼Œå¯ä»¥å¾—çŸ¥å†…éƒ¨ä¸ºæ¯ä¸ªå¯¹è±¡å±æ€§æ·»åŠ ä¸€ä¸ª<code>__ob__</code>ï¼Œè¿™é‡Œæ‹¿åˆ°çš„ childOb å°±æ˜¯ä¸ºå½“å‰å±æ€§åˆ›å»ºçš„ Obsever å®ä¾‹ã€‚</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    configurable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> value <span class="token operator">=</span> getter <span class="token operator">?</span> <span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">:</span> val<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>childOb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          childOb<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">dependArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> value
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><ul><li>get ç‰¹æ€§ï¼Œå–å€¼çš„æ—¶å€™ä¼šè§¦å‘ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ value æ˜¯å–åˆ°çš„å‡½æ•°å†…çš„é—­åŒ…å˜é‡ valï¼Œç›¸åº”çš„åœ¨ set å†…éƒ¨èµ‹å€¼çš„æ—¶å€™ä¹Ÿæ˜¯è®¾ç½®è¿™ä¸ªé—­åŒ…å˜é‡ï¼Œå¦‚æœæ²¡æœ‰è¿™ä¸ªå˜é‡ï¼Œç›´æ¥ obj.val çš„æ–¹å¼å–å€¼çš„åŒ–ï¼Œå°±ä¼šä¸æ–­å¾ªç¯ï¼ˆåœ¨ get å†…éƒ¨å†æ¬¡åŠèµ· getï¼‰å¯¼è‡´ stackoverflowã€‚å–å®Œå€¼ä¹‹åæ£€æŸ¥ Dep.targetï¼Œä¹Ÿå°±æ˜¯å½“å‰å˜é‡ä½¿ç”¨çš„ç¯å¢ƒï¼Œå‡è®¾åœ¨æ¸²æŸ“çš„è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸ª target å°±æ˜¯ render-watcherï¼Œå¦‚æœåœ¨è®¡ç®—å±æ€§è¢«ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸ª target åˆ™ä¸º computed-watcherã€‚ç¡®å®šç¯å¢ƒ watcher ä¹‹åå°±å¯ä»¥è¿›è¡Œä¾èµ–æ”¶é›†ã€‚æ­¤æ—¶å½“å‰ value å€¼ä¼šè®¿é—®åˆ°é—­åŒ…å˜é‡ depï¼Œé€šè¿‡ dep.depend()å»å§ target æ·»åŠ åˆ° dep.subs ä¹Ÿå°±æ˜¯è®¢é˜…è€…åˆ—è¡¨ã€‚å¦‚æœå½“å‰çš„å€¼æ˜¯å¯¹è±¡ç±»å‹çš„ï¼Œå°±ä¼šé€šè¿‡ observe()å»è·å–å¯¹è±¡çš„<code>__ob__.dep</code>ï¼Œè®©è¿™ä¸ªå¯¹è±¡ç±»å‹çš„å±æ€§ä¹Ÿæ”¶é›†åˆ°å½“å‰ targetï¼Œä¹Ÿå°±æ˜¯è¿›è¡Œæ·±å±‚çš„ä¾èµ–æ”¶é›†ï¼Œä¸ºçš„æ˜¯åœ¨ç»™å¯¹è±¡æˆ–è€…æ•°ç»„æ·»åŠ é¢å¤–å±æ€§æˆ–è€…åˆ é™¤å±æ€§çš„æ—¶å€™å¯ä»¥è¿›è¡Œå“åº”å¼æ“ä½œï¼ˆä¸º vm.$set vm.$delete åš hackï¼‰ã€‚</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>    <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveSetter</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> value <span class="token operator">=</span> getter <span class="token operator">?</span> <span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">:</span> val<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newVal <span class="token operator">===</span> value <span class="token operator">||</span> <span class="token punctuation">(</span>newVal <span class="token operator">!==</span> newVal <span class="token operator">&amp;&amp;</span> value <span class="token operator">!==</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// çœ‹çœ‹å€¼å˜äº†æ²¡æœ‰ å¦‚æœæ²¡å˜ä¹Ÿæ— éœ€åç»­æµç¨‹</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> customSetter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">customSetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ä»£ç æç¤º</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>getter <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>setter<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// æ²¡æœ‰setterç›´æ¥return</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>setter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// çœŸæ­£çš„èµ‹å€¼</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        val <span class="token operator">=</span> newVal<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      childOb <span class="token operator">=</span> <span class="token operator">!</span>shallow <span class="token operator">&amp;&amp;</span> <span class="token function">observe</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å¤„ç†ä¼ å…¥çš„å¯¹è±¡ç±»å‹çš„å€¼</span>
      dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å“åº”å¼æ›´æ–°</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>set ç‰¹æ€§ åœ¨ get ç‰¹æ€§ä¸­è¿›è¡Œäº†ä¾èµ–æ”¶é›†ä¹‹åï¼Œå°±å¯ä»¥åœ¨ set è¢«è§¦å‘çš„æ—¶å€™å¯¹è®¢é˜…è€…è¿›è¡Œé€šçŸ¥ï¼Œå®Œæˆè§†å›¾æ›´æ–°æˆ–è€…å»è°ƒç”¨ç”¨æˆ·ä¼ å…¥çš„å›è°ƒã€‚é¦–å…ˆè®¿é—®é—­åŒ…å˜é‡å»å¯¹æ¯”æ–°ä¼ å…¥çš„å€¼æœ‰æ²¡æœ‰å˜åŒ–ï¼Œå¦‚æœæ²¡å˜ç›´æ¥ returnã€‚æŠŠæ–°å€¼èµ‹å€¼ç»™åŸå±æ€§ï¼Œè¿™é‡Œè¦æ³¨æ„ï¼Œéœ€è¦ç”¨ observe å¯¹æ–°ä¼ å…¥çš„å€¼è¿›è¡Œå“åº”å¼å¤„ç†ï¼Œä¸ºçš„æ˜¯å¦‚è¿‡ä¼ å…¥äº†å¯¹è±¡ç±»å‹çš„å€¼ï¼Œä¸ä¸ºå…¶æ³¨å†Œå“åº”å¼å°±ä¼šå¯¼è‡´è¯¥å¯¹è±¡å±æ€§æ›´æ–°ä¹‹åä¸ä¼šè®©è§†å›¾æ›´æ–°ã€‚åœ¨æ³¨å†Œå®Œæ¯•ä¹‹åï¼Œå°±ä¼šé€šè¿‡ dep.notify å»é€šçŸ¥æ‰€æœ‰è®¢é˜…è€…è¿›è¡Œè§†å›¾æ›´æ–°æˆ–è€…è§¦å‘å›è°ƒã€‚</li></ul> <h4 id="observe-ä¸ºå¯¹è±¡ç±»å‹çš„å±æ€§å®šä¹‰å“åº”å¼"><a href="#observe-ä¸ºå¯¹è±¡ç±»å‹çš„å±æ€§å®šä¹‰å“åº”å¼" class="header-anchor">#</a> observe - ä¸ºå¯¹è±¡ç±»å‹çš„å±æ€§å®šä¹‰å“åº”å¼</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">observe</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> asRootData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// å¦‚æœä¼ å…¥çš„éœ€è¦è§‚å¯Ÿçš„å€¼ä¸æ˜¯ä¸€ä¸ªå¯¹è±¡æˆ–è€…æ˜¯æ•°ç»„ æˆ–è€…æ˜¯ä¸€ä¸ªVnodeç±»å‹çš„å¯¹è±¡ éƒ½ä¼šç›´æ¥return</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span> value <span class="token keyword">instanceof</span> <span class="token class-name">VNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> ob<span class="token punctuation">;</span>
  <span class="token comment">// é¦–å…ˆæ£€æŸ¥å½“å‰å¯¹è±¡åŒ…ä¸åŒ…å«è‡ªå·±çš„__ob__ å¦‚æœæœ‰ç›´æ¥è¿”å›å½“å‰å¯¹è±¡çš„__ob__</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">&quot;__ob__&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>__ob__ <span class="token keyword">instanceof</span> <span class="token class-name">Observer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ob <span class="token operator">=</span> value<span class="token punctuation">.</span>__ob__<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
    shouldObserve <span class="token operator">&amp;&amp;</span> <span class="token comment">// å½“å‰çŠ¶æ€æ˜¯ä¸æ˜¯å¯è§‚å¯Ÿçš„ ï¼ˆï¼‰</span>
    <span class="token operator">!</span><span class="token function">isServerRendering</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">// æ˜¯ä¸æ˜¯æœåŠ¡å™¨ç«¯æ¸²æŸ“çš„</span>
    <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isPlainObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">// æ£€æµ‹å½“å‰valueå€¼å¿…é¡»æ˜¯ä¸¥æ ¼å¯¹è±¡æˆ–è€…æ˜¯æ•°ç»„æ‰ä¼šä¸ºå…¶æ³¨å†Œå¤–å±‚obï¼Œç„¶åæ·»åŠ depã€‚</span>
    Object<span class="token punctuation">.</span><span class="token function">isExtensible</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">// æŸ¥çœ‹å½“å‰å¯¹è±¡æ˜¯ä¸æ˜¯å¯æ‰©å±•çš„</span>
    <span class="token operator">!</span>value<span class="token punctuation">.</span>_isVue <span class="token comment">// æœ€åæ£€æµ‹å½“å‰å€¼ä¸æ˜¯vueå®ä¾‹ é¿å…å»è§‚å¯Ÿvm</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ç›´æ¥new ob æœ€åè¿”å›ob</span>
    ob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>asRootData <span class="token operator">&amp;&amp;</span> ob<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¦‚æœå½“å‰æ˜¯ä½œä¸ºrootdataä¼ è¿›æ¥ ä¹Ÿå°±æ˜¯è¯´å½“å‰ä¼ å…¥vm._data</span>
    ob<span class="token punctuation">.</span>vmCount<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> ob<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>observe é¦–å…ˆå‰”é™¤éå¯¹è±¡å€¼å’Œ vnodeã€‚ç„¶åæ£€æŸ¥å½“å‰å¯¹è±¡æ˜¯å¦å·²ç»æ˜¯å“åº”å¼çš„äº†ï¼Œå¦‚æœå·²ç»æ˜¯å°±ç›´æ¥æ‹¿åˆ°å¯¹è±¡çš„<code>__ob__</code>è¿”å›ï¼Œå¦‚æœä¸æ˜¯å“åº”å¼çš„å°±é€šè¿‡ new Obsever å»æ³¨å†Œå“åº”å¼å¹¶è¿”å›è¿™ä¸ªå¯¹è±¡ã€‚</p> <p>è‡³æ­¤ï¼Œå¯¹ defineReactive çš„è¿‡ç¨‹è¿›è¡Œä¸€ä¸ªç®€å•çš„æµç¨‹æ¢³ç†ã€‚</p> <div class="language-mermaid extra-class"><pre class="language-text"><code>graph TB
A[defineReactive]  --&gt; B(å¯¹è±¡æ•°ç»„ç±»å‹)
B --&gt; D(observe)
D --&gt; F(æ•°ç»„)
F --&gt;H(observeArray)
H --&gt; D
D --&gt; G(å¯¹è±¡)
G --&gt; I(walk)
I --&gt; A
A --&gt; C(åŸºæœ¬ç±»å‹)
C --&gt; E(ç»“æŸ)
</code></pre></div><h4 id="initstate-åˆå§‹åŒ–æ•°æ®"><a href="#initstate-åˆå§‹åŒ–æ•°æ®" class="header-anchor">#</a> initState åˆå§‹åŒ–æ•°æ®</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">initState</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  vm<span class="token punctuation">.</span>_watchers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> opts <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">initProps</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// åˆå§‹åŒ–props</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>methods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">initMethods</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>methods<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// åˆå§‹åŒ–method</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä¸ºdataé€’å½’æ·»åŠ äº†__ob__ åœ¨åˆ›å»º__ob__çš„è¿‡ç¨‹ä¸­ä¼šdefineRectiveæ–¹æ³•è¿›è¡Œå“åº”å¼æ³¨å†Œ</span>
    <span class="token function">initData</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* asRootData */</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ä¼ å…¥vm._data asRootData = true</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>computed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆå§‹åŒ–computed</span>
    <span class="token function">initComputed</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>computed<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>watch <span class="token operator">&amp;&amp;</span> opts<span class="token punctuation">.</span>watch <span class="token operator">!==</span> nativeWatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">initWatch</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>watch<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// åˆå§‹åŒ–watch</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¯ä»¥å‘ç° initState å†…éƒ¨ç»“æ„éå¸¸æ¸…æ™°ï¼Œå…±åˆ†ä¸ºä»¥ä¸‹å‡ éƒ¨åˆ†ã€‚</p> <ul><li>åˆå§‹åŒ– props</li> <li>åˆå§‹åŒ– method</li> <li>åˆå§‹åŒ– data</li> <li>åˆå§‹åŒ– computed</li> <li>åˆå§‹åŒ– watch
æ¥ä¸‹æ¥çœ‹çœ‹è¿™äº›åˆå§‹åŒ–éƒ½åšäº†ä»€ä¹ˆã€‚</li></ul> <h5 id="initprops"><a href="#initprops" class="header-anchor">#</a> initProps</h5> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">initProps</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> propsOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> propsData <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>propsData <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// ç»„ä»¶å ä½èŠ‚ç‚¹ä¼ å…¥çš„props</span>
  <span class="token keyword">var</span> props <span class="token operator">=</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_props <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç»„ä»¶optionsä¸Šçš„_props (å°†ä¼šè¢«vmè‡ªèº«ä»£ç†)</span>
  <span class="token comment">// ç¼“å­˜propskeysåˆ°æ•°ç»„ä¸­å» å°±å¯ä»¥ä½¿ç”¨æ•°ç»„çš„éå† è€Œä¸ç”¨ä½¿ç”¨å¯¹è±¡çš„åŠ¨æ€æšä¸¾</span>
  <span class="token keyword">var</span> keys <span class="token operator">=</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>_propKeys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> isRoot <span class="token operator">=</span> <span class="token operator">!</span>vm<span class="token punctuation">.</span>$parent<span class="token punctuation">;</span>
  <span class="token comment">// root instance props should be converted</span>
  <span class="token comment">// å¦‚æœä¸æ˜¯æ ¹ç»„ä»¶çš„è¯å°±ä¸å»ä¸ºå½“å‰propsä¸­çš„å¯¹è±¡ç±»å‹çš„å˜é‡åˆ›å»º Observer</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">toggleObserving</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> <span class="token function-variable function">loop</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    keys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å¯¹æ¯ä¸ªpropså€¼è¿›è¡Œç±»å‹åŒ¹é…å’Œè½¬æ¢</span>
    <span class="token keyword">var</span> value <span class="token operator">=</span> <span class="token function">validateProp</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> propsOptions<span class="token punctuation">,</span> propsData<span class="token punctuation">,</span> vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">defineReactive$$1</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> vm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">proxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">&quot;_props&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> propsOptions<span class="token punctuation">)</span> <span class="token function">loop</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">toggleObserving</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>initprops å†…éƒ¨ä¹Ÿå¾ˆç®€å•ï¼Œæ–°å»ºä¸€ä¸ªå¯¹è±¡ï¼Œç„¶åé€šè¿‡éå†ç»„ä»¶ä¼ å…¥çš„ props è¿›è¡Œæ³¨å†Œå“åº”å¼ï¼Œå…¶ä¸­æœ‰å‡ ä¸ªå‚æ•°ã€‚</p> <ul><li>propsOptions ç»„ä»¶å†…éƒ¨å®šä¹‰çš„å¯ä»¥æ¥å—çš„ propsï¼ˆexport default åˆ°å¤„çš„å¯¹è±¡çš„ propsï¼‰</li> <li>propsData ç»„ä»¶å ä½èŠ‚ç‚¹ä¼ å…¥çš„ propsï¼Œä¹Ÿå°±æ˜¯çœŸæ­£ç”¨åˆ°çš„ props</li> <li>_props propsData é€šè¿‡ defineReactive å“åº”å¼å¤„ç†åçš„ props</li> <li>_propKeys propsData ä¸­çš„æ¯ä¸ªå±æ€§åç»„æˆçš„æ•°ç»„
è¿˜æœ‰å‡ ä¸ªç»†èŠ‚å€¼å¾—æ³¨æ„ï¼š</li> <li>validateProp åœ¨è®¾ç½® prop çš„æ—¶å€™å¯ä»¥ä¼ å…¥ type å±æ€§ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯æŠŠç«™ä½èŠ‚ç‚¹ä¸Šçš„æ•°æ®è½¬æ¢æˆå¯¹åº”çš„ç±»å‹ã€‚</li> <li>toggleObserving å› ä¸º props æ˜¯ä»çˆ¶ç»„ä»¶ä¸Šä¼ é€’è¿‡æ¥çš„ï¼Œå¯¹äºå¯¹è±¡ç±»å‹å€¼å…¶å®æ˜¯çˆ¶ç»„ä»¶å†…å®šä¹‰çš„ï¼Œä¹Ÿå°±å·²ç»æ³¨å†Œäº†å“åº”å¼ï¼Œæ‰€ä»¥æ— éœ€å†æ¬¡ä¸ºå¯¹è±¡ç±»å‹æ³¨å†Œæ·±å±‚å“åº”å¼ï¼Œåœ¨ä½¿ç”¨å±æ€§çš„æ—¶å€™å°±ä¼šè®°å½•å­ç»„ä»¶å†…ç›¸å…³çš„ watcherï¼ˆä¾èµ–æ”¶é›†ï¼‰ï¼Œè¿™æ ·åœ¨çˆ¶ç»„ä»¶ä¸­ä¿®æ”¹æ•°æ®ï¼Œå­ç»„ä»¶ä¹Ÿä¼šå‘ç”Ÿå˜åŒ–ã€‚</li> <li>proxy ä¸ºäº†ç”¨æˆ·æ–¹ä¾¿ä½¿ç”¨ï¼Œå¯ä»¥é€šè¿‡ this['å±æ€§å']çš„æ–¹å¼è°ƒç”¨ props å±æ€§ï¼Œé€šè¿‡ proxy å»ä»£ç†åˆ° vm æœ¬èº«ã€‚</li></ul> <h5 id="initmethods"><a href="#initmethods" class="header-anchor">#</a> initMethods</h5> <p>method ç›¸å¯¹äº props æ›´ä¸ºç®€å•ï¼Œä»…ä»…åšäº† this çš„ç»‘å®šï¼Œå¦‚ä¸‹ï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">initMethods</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> methods</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> props <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>props<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> methods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span>
      <span class="token keyword">typeof</span> methods<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">&quot;function&quot;</span> <span class="token operator">?</span> noop <span class="token operator">:</span> <span class="token function">bind</span><span class="token punctuation">(</span>methods<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>è¿™é‡Œçš„ bind éå¸¸ç²¾å¦™ï¼Œå§‹ç»ˆå°†å½“å‰ method ç»‘å®šåœ¨å½“å‰ç»„ä»¶çš„ä½œç”¨åŸŸä¸­ï¼ˆå½“å‰ç»„ä»¶å®ä¾‹ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å‰ç»„ä»¶çš„ method ä¸­çš„ this å§‹ç»ˆæŒ‡å‘çˆ¶ç»„ä»¶ vm æœ¬èº«ï¼Œè¿™ä¹ˆåšä¹Ÿå°±ä¸ºäº†å‡½æ•°å’Œå±æ€§å®šä¹‰åœ¨å“ªé‡Œï¼Œè¿è¡Œä½œç”¨åŸŸå°±åœ¨å“ªé‡Œã€‚</li> <li>åœ¨çˆ¶å­ç»„ä»¶é€šä¿¡çš„è¿‡ç¨‹ä¸­ï¼Œå½“ç»„ä»¶åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä»å ä½èŠ‚ç‚¹ä¸Šæ‹¿åˆ°çš„æ–¹æ³•ä¼šåœ¨åˆ›å»ºç»„ä»¶å®ä¾‹çš„æ—¶å€™ï¼Œä¼ é€’åˆ°å­ç»„ä»¶çš„äº‹ä»¶ä¸­å¿ƒä¸­ï¼ˆç¬¬ä¸‰ç« æœ‰åˆ†æè¿‡ï¼šç»„ä»¶å ä½èŠ‚ç‚¹ä¸Šå®šä¹‰çš„æ–¹æ³•ä¼šä¼ ç»™ç»„ä»¶æ¸²æŸ“èŠ‚ç‚¹çš„äº‹ä»¶ä¸­å¿ƒä¸­å»<code>_events[eventName]</code>ï¼‰ã€‚å»å½“å­ç»„ä»¶$emit ä¸€ä¸ªæ–¹æ³•çš„æ—¶å€™å°±ä¼šè§¦å‘åˆ°äº‹ä»¶ä¸­å¿ƒçš„å¯¹åº”æ–¹æ³•æˆ–è€…æ–¹æ³•æ•°ç»„ï¼Œä»åŸç†ä¸Šè®²å­ç»„ä»¶å®é™…ä¸Šä¸ºè‡ªå·±æ´¾å‘äº†ä¸€ä¸ªäº‹ä»¶ï¼Œè€Œä¸æ˜¯ä¸ºçˆ¶ç»„ä»¶æ´¾å‘äº†ä¸€ä¸ªäº‹ä»¶ã€‚
äºæ˜¯ ï¼šè¿™ä¸ªæ–¹æ³•å®šä¹‰åœ¨çˆ¶ç»„ä»¶ï¼Œè¿è¡Œåœ¨çˆ¶ç»„ä»¶ï¼Œå´ä¿å­˜åœ¨å­ç»„ä»¶ã€‚ç»™ç”¨æˆ·ä¸€ç§çˆ¶å­ç»„å»ºé€šä¿¡çš„é”™è§‰ã€‚</li></ul> <h5 id="initdata"><a href="#initdata" class="header-anchor">#</a> initData</h5> <p>ä¸ºç»„ä»¶å†…éƒ¨çš„æ•°æ®è¿›è¡Œå“åº”å¼æ³¨å†Œã€‚</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">initData</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> data <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
  <span class="token comment">// é¦–å…ˆåˆ¤æ–­dataæ˜¯ä¸æ˜¯function å¦‚æœæ˜¯ æ‰§è¡Œå‡½æ•°  å¦‚æœä¸æ˜¯ ç›´æ¥è¿”å›data</span>
  <span class="token comment">// (å¦‚æœæ˜¯éfunctionç±»å‹çš„é¢å°†ä¼šå¯¼è‡´æ‰€æœ‰çš„ä½¿ç”¨è¯¥ç»„ä»¶çš„åœ°æ–¹ç›¸äº’å½±å“ - å¼•ç”¨ä¼ é€’)</span>
  data <span class="token operator">=</span> vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token keyword">typeof</span> data <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span> <span class="token operator">?</span> <span class="token function">getData</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> vm<span class="token punctuation">)</span> <span class="token operator">:</span> data <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> i <span class="token operator">=</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isReserved</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">proxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">&quot;_data&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* asRootData */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>é€šè¿‡ observe å¯¹ data æ³¨å†Œæ·±å±‚çš„å“åº”å¼ã€‚</p> <h4 id="initcomputed"><a href="#initcomputed" class="header-anchor">#</a> initComputed</h4> <p>è®¡ç®—å±æ€§æœ¬è´¨ä¸Šå°±æ˜¯ watcherï¼Œåªä¸è¿‡è®¡ç®—å±æ€§æ˜¯ lazy çš„ï¼Œåªæœ‰è¢«ç”¨åˆ°çš„æ—¶å€™æ‰ä¼šé‡æ–°è®¡ç®—å€¼ã€‚</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">initComputed</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> computed</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// é¦–å…ˆä¸ºå½“å‰vmåˆ›å»ºä¸€ä¸ªå“ˆå¸Œè¡¨ä¿å­˜è®¡ç®—å±æ€§çš„watcher</span>
  <span class="token keyword">var</span> watchers <span class="token operator">=</span> vm<span class="token punctuation">.</span>_computedWatchers <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> computed<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// éå†</span>
    <span class="token keyword">var</span> userDef <span class="token operator">=</span> computed<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> getter <span class="token operator">=</span> <span class="token keyword">typeof</span> userDef <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> userDef <span class="token operator">:</span> userDef<span class="token punctuation">.</span>get<span class="token punctuation">;</span>

    watchers<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>
      vm<span class="token punctuation">,</span>
      getter <span class="token operator">||</span> noop<span class="token punctuation">,</span>
      noop<span class="token punctuation">,</span>
      computedWatcherOptions
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> vm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token function-variable function">get</span><span class="token operator">:</span><span class="token keyword">function</span> <span class="token function">computedGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// é¦–å…ˆæ‹¿åˆ°å“ˆå¸Œè¡¨ä¸­å¯¹åº”çš„watcher</span>
              <span class="token keyword">var</span> watcher <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_computedWatchers <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_computedWatchers<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>watcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>watcher<span class="token punctuation">.</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// åˆ¤æ–­è®¡ç®—ç»“æœå€¼å˜äº†æ²¡æœ‰</span>
                  watcher<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å˜äº†å°±è¿›è¡Œä¸€æ¬¡evaluate åˆå§‹åŒ–çš„æ—¶å€™ä¹Ÿè¦æ‰§è¡Œä¸€æ¬¡è®¡ç®—</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  watcher<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å¯¹æ‰€æœ‰å½“å‰è®¡ç®—å±æ€§æ‰€æœ‰ä¾èµ–é¡¹è¿›è¡Œå½“å‰targetä¸‹çš„ä¾èµ–æ”¶é›†</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> watcher<span class="token punctuation">.</span>value <span class="token comment">// è¿”å›æœ€æ–°çš„è®¡ç®—å±æ€§å€¼</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>Ã
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¯ä»¥çœ‹åˆ°é‡æ–°å®šä¹‰äº†è®¡ç®—å±æ€§çš„å€¼ï¼Œåœ¨è·å–è®¡ç®—å±æ€§çš„æ—¶å€™åŒæ · Object.defineProperty å»æ·»åŠ ä¸€ä¸ª get ç‰¹æ€§ã€‚å¯ä»¥å‘ç°è®¡ç®—å±æ€§æœ‰ä¸¤ä¸ªç‰¹ç‚¹</p> <ul><li>è®¡ç®—å±æ€§åªæœ‰åœ¨çœŸæ­£è°ƒç”¨åˆ°çš„æ—¶å€™æ‰ä¼šé€šè¿‡è®¡ç®—å±æ€§çš„ watcher.evaluate å»è®¡ç®—å€¼ã€‚</li> <li>åœ¨æ‰§è¡Œå®Œ watcher.evaluate ä¹‹åï¼ŒDep.target æŒ‡å‘çš„å½“å‰è®¡ç®—å±æ€§çš„ç¯å¢ƒ watcher ä¹‹ä¸­ï¼Œå¯èƒ½æ˜¯å…¶ä»–è®¡ç®—å±æ€§ï¼Œuser-watcherï¼Œæˆ–è€…æ˜¯ render-wathcerï¼Œé€šè¿‡ watcher.depend å¾ªç¯ watcher.deps ä¸­çš„æ¯ä¸€ä¸ª dep å»è¿›è¡Œä¾èµ–æ”¶é›†,è¿™æ ·åšçš„ç›®çš„æ˜¯æŠŠå½“å‰<strong>è®¡ç®—å±æ€§ä¸­ç”¨åˆ°çš„</strong>å“åº”å¼å±æ€§å’Œå½“å‰è®¡ç®—å±æ€§çš„ç¯å¢ƒ watcher å»ºç«‹å…³ç³»,è¿™æ · computed å†…éƒ¨å±æ€§å˜åŒ–çš„æ—¶å€™å°±ä¼šé€šçŸ¥åˆ° computed æ‰€åœ¨çš„ watcher ç¯å¢ƒå»å“åº”å¼å˜åŒ–ï¼Œè¿™æ—¶å€™å°±ä¼šå†æ¬¡è¿›å…¥åˆ°è¿™ä¸ªæ–¹æ³•ï¼Œè°ƒç”¨ watcher.evaluate è·å–è®¡ç®—å±æ€§çš„ç»“æœç„¶åè¿”å›ã€‚ä¹Ÿå°±è¾¾åˆ°äº†è®¡ç®—å±æ€§ä¸­çš„ç”¨åˆ°çš„å€¼å˜äº†å°±ä¼šå»è§¦å‘è®¡ç®—å±æ€§é‡æ–°è®¡ç®—ï¼Œé¦–å…ˆè§¦å‘ computed å±æ€§çš„ watcher æŠŠå½“å‰çŠ¶æ€è®¾ç½®ä¸º dirtyï¼Œè¿™æ ·ä¸€æ¥å†è§¦å‘ç¯å¢ƒ watcher çš„ update æ–¹æ³•çš„æ—¶å€™å°±å¯ä»¥é¡ºåˆ©è§¦å‘ evaluate é‡æ–°è®¡ç®—å€¼ã€‚ï¼ˆè¿™ä¸ªè§¦å‘é¡ºåºæ˜¯ä¸¥æ ¼ä¿è¯çš„ï¼Œåœ¨ queueWatcher çš„å†…éƒ¨å®Œæˆæ’åºï¼Œåç»­ä¼šä»”ç»†åˆ†æï¼‰ã€‚</li></ul> <h4 id="initwatch"><a href="#initwatch" class="header-anchor">#</a> initWatch</h4> <p>åˆå§‹åŒ–ç”¨æˆ·å®šä¹‰çš„ watchï¼Œæ²¡æœ‰ä»€ä¹ˆé¢å¤–æ³¨æ„çš„åœ°æ–¹,éå†å»æ·»åŠ  user-wathcerã€‚</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">initWatch</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> watch</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> watch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> handler <span class="token operator">=</span> watch<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    options<span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> handler<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="ç»“"><a href="#ç»“" class="header-anchor">#</a> ç»“</h4> <p>æœ¬ç« å†…å®¹éå¸¸ç¹æ‚ï¼Œéš¾ç†è§£çš„éƒ¨åˆ†è¾ƒå¤šï¼Œåç»­ç« èŠ‚å°†ä¼šåˆ†æä»æŒ‚è½½åˆ°æ¸²æŸ“çš„è¿‡ç¨‹ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šä¸æ–­çš„æ¸—é€å“åº”å¼åŸç†ï¼Œå“åº”å¼ç³»ç»Ÿä¹Ÿæ˜¯ vue ä¸­å¾ˆé‡è¦çš„ä¸€éƒ¨åˆ†ï¼Œéœ€è¦ä¸æ–­çš„æ·±å…¥å­¦ä¹ åŠä½¿ç”¨æ‰èƒ½ä½“ä¼šå¥¥å¦™ã€‚</p> <p>ã€Šå®Œã€‹</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/frontend/vue_vuex_vue-router_nuxt/vcode/3.html" class="prev">
        åœ¨new Vue(options)ä¸­æ˜¯å¦‚ä½•ä¸ºoptionsè¿›è¡Œåˆå§‹åŒ–ï¼ˆä¸‰ï¼‰
      </a></span> <span class="next"><a href="/frontend/vue_vuex_vue-router_nuxt/vcode/5.html">
        ä»$mountåˆ°è™šæ‹Ÿdomï¼ˆäº”ï¼‰
      </a>
      â†’
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d0f45259.js" defer></script><script src="/assets/js/2.9e697bc4.js" defer></script><script src="/assets/js/46.cede0b20.js" defer></script>
  </body>
</html>
